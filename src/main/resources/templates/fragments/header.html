<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <!-- This head section will be replaced by the including page -->
</head>
<body>
    <!-- Modern Header Fragment -->
    <header th:fragment="header" class="modern-header bg-white shadow-sm">
        <div class="container">
            <div class="row align-items-center py-2">
                <!-- Logo -->
                <div class="col-lg-3 col-md-4 col-6">
                    <a th:href="@{/}" class="logo-brand d-flex align-items-center text-decoration-none">
                        <!-- Desktop Logo -->
                        <img src="https://files.catbox.moe/4ka4id.webp" 
                             alt="Đặc Sản Việt" 
                             class="logo-image logo-desktop">
                        <!-- Mobile Logo -->
                        <img src="https://files.catbox.moe/c373f9.webp" 
                             alt="Đặc Sản Việt" 
                             class="logo-image logo-mobile">
                    </a>
                </div>
                
                <!-- Navigation Menu -->
                <div class="col-lg-6 col-md-4 d-none d-lg-block">
                    <nav class="main-nav">
                        <ul class="nav-menu d-flex justify-content-center list-unstyled mb-0">
                            <li class="nav-item me-4">
                                <a th:href="@{/}" class="nav-link text-dark fw-semibold position-relative">
                                    Trang chủ
                                </a>
                            </li>
                            <li class="nav-item dropdown me-4">
                                <a href="#" class="nav-link text-dark fw-semibold position-relative">
                                    Sản Phẩm
                                    <i class="fas fa-chevron-down ms-1" style="font-size: 0.75rem;"></i>
                                </a>
                                <ul class="dropdown-menu border-0 shadow-lg">
                                    <li th:each="category : ${categories}">
                                        <a class="dropdown-item py-2" th:href="@{/products(categoryId=${category.id})}">
                                            <i class="fas fa-tag me-2" th:classappend="${category.id == 1 ? 'text-primary' : (category.id == 2 ? 'text-warning' : 'text-info')}"></i>
                                            <span th:text="${category.name}">Tên danh mục</span>
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item py-2" th:href="@{/products}">
                                        <i class="fas fa-th text-success me-2"></i>Tất Cả Sản Phẩm
                                    </a></li>
                                </ul>
                            </li>
                            <li class="nav-item me-4">
                                <a href="#" class="nav-link text-dark fw-semibold position-relative">
                                    Giới thiệu
                                </a>
                            </li>
                            <li class="nav-item me-4">
                                <a href="#" class="nav-link text-dark fw-semibold position-relative">
                                    Tin tức
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link text-dark fw-semibold position-relative">
                                    Liên hệ
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
                
                <!-- Right Side Actions -->
                <div class="col-lg-3 col-md-4 col-6">
                    <div class="header-actions d-flex align-items-center justify-content-end">
                        <!-- Cart Icon -->
                        <div class="cart-icon-wrapper position-relative me-3">
                            <a th:href="@{/cart}" class="cart-icon text-decoration-none d-block position-relative">
                                <i class="bi bi-bag fs-4 text-dark"></i>
                            </a>
                            <span class="cart-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" 
                                  style="font-size: 0.65rem; padding: 0; min-width: 20px; height: 20px; line-height: 1; display: none; align-items: center; justify-content: center;">0</span>
                        </div>
                        
                        <!-- Inline script to immediately update cart badge -->
                        <script>
                            (function() {
                                function updateCartBadgeNow() {
                                    try {
                                        const cart = localStorage.getItem('shopping_cart');
                                        const cartData = cart ? JSON.parse(cart) : { items: [] };
                                        const count = cartData.items.reduce((total, item) => total + (item.quantity || 0), 0);
                                        
                                        console.log('Updating cart badge - count:', count, 'cart items:', cartData.items.length);
                                        
                                        const badges = document.querySelectorAll('.cart-badge');
                                        badges.forEach(badge => {
                                            if (count > 0) {
                                                badge.textContent = count;
                                                badge.style.display = 'flex';
                                                badge.style.visibility = 'visible';
                                                badge.style.opacity = '1';
                                            } else {
                                                badge.textContent = '0';
                                                badge.style.display = 'none';
                                                badge.style.visibility = 'hidden';
                                                badge.style.opacity = '0';
                                            }
                                        });
                                    } catch (e) {
                                        console.error('Error updating cart badge:', e);
                                    }
                                }
                                
                                // Run immediately
                                updateCartBadgeNow();
                                
                                // Run when DOM is ready
                                if (document.readyState === 'loading') {
                                    document.addEventListener('DOMContentLoaded', updateCartBadgeNow);
                                } else {
                                    updateCartBadgeNow();
                                }
                                
                                // CRITICAL: Run on pageshow (back button) - this must work!
                                window.addEventListener('pageshow', function(event) {
                                    console.log('pageshow event - persisted:', event.persisted);
                                    updateCartBadgeNow();
                                });
                                
                                // Run on storage change
                                window.addEventListener('storage', function(e) {
                                    if (e.key === 'shopping_cart') {
                                        console.log('storage event - cart changed');
                                        updateCartBadgeNow();
                                    }
                                });
                                
                                // Run on focus
                                window.addEventListener('focus', function() {
                                    console.log('window focus - updating cart');
                                    updateCartBadgeNow();
                                });
                                
                                // Run on visibilitychange
                                document.addEventListener('visibilitychange', function() {
                                    if (!document.hidden) {
                                        console.log('page visible - updating cart');
                                        updateCartBadgeNow();
                                    }
                                });
                                
                                // Polling as last resort - check every 2 seconds when page is visible
                                setInterval(function() {
                                    if (!document.hidden) {
                                        updateCartBadgeNow();
                                    }
                                }, 2000);
                            })();
                        </script>
                        
                        <!-- User Avatar/Login -->
                        <div class="user-section">
                            <!-- Authenticated User -->
                            <div sec:authorize="isAuthenticated()" class="dropdown">
                                <a href="#" class="user-avatar text-decoration-none d-flex align-items-center" 
                                   data-bs-toggle="dropdown" aria-expanded="false">
                                    <div class="avatar-circle d-flex align-items-center justify-content-center me-2">
                                        <span class="avatar-text fw-bold text-white" 
                                              th:text="${#strings.substring(#authentication.principal.fullName != null ? #authentication.principal.fullName : #authentication.name, 0, 1).toUpperCase()}">U</span>
                                    </div>
                                    <span class="text-dark d-none d-md-inline" style="font-size: 0.9rem;">
                                        Xin chào, <strong th:text="${#authentication.principal.fullName}">User</strong>
                                    </span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg">
                                    <li class="dropdown-header">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle-small me-2">
                                                <span class="avatar-text-small fw-bold text-white" 
                                                      th:text="${#strings.substring(#authentication.principal.fullName, 0, 1).toUpperCase()}">U</span>
                                            </div>
                                            <div>
                                                <div class="fw-semibold" th:text="${#authentication.principal.fullName}">User</div>
                                            </div>
                                        </div>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item py-2" th:href="@{/profile}">
                                        <i class="bi bi-person me-2 text-primary"></i>Thông tin cá nhân
                                    </a></li>
                                    <li><a class="dropdown-item py-2" th:href="@{/orders}">
                                        <i class="bi bi-bag me-2 text-success"></i>Đơn hàng của tôi
                                    </a></li>
                                    <li><a class="dropdown-item py-2" th:href="@{/cart}">
                                        <i class="bi bi-cart me-2 text-warning"></i>Giỏ hàng
                                    </a></li>
                                    <li sec:authorize="hasRole('ADMIN')">
                                        <a class="dropdown-item py-2" th:href="@{/admin/dashboard}">
                                            <i class="bi bi-speedometer2 me-2 text-info"></i>Quản trị hệ thống
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form th:action="@{/logout}" method="post" class="d-inline w-100">
                                            <button type="submit" class="dropdown-item py-2 text-danger">
                                                <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                            
                            <!-- Anonymous User -->
                            <div sec:authorize="!isAuthenticated()" class="login-section d-flex align-items-center">
                                <a th:href="@{/login}" class="btn btn-outline-primary btn-sm me-2">
                                    <i class="bi bi-box-arrow-in-right me-1"></i>Đăng nhập
                                </a>
                                <a th:href="@{/register}" class="btn btn-primary btn-sm d-none d-md-inline-block">
                                    <i class="bi bi-person-plus me-1"></i>Đăng ký
                                </a>
                            </div>
                        </div>
                        
                        <!-- Mobile Menu Toggle -->
                        <button class="mobile-menu-toggle btn btn-outline-secondary d-lg-none ms-2" 
                                type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
                            <i class="bi bi-list"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Mobile Menu Offcanvas Fragment -->
    <div th:fragment="mobile-menu" class="offcanvas offcanvas-end" tabindex="-1" id="mobileMenu">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title fw-bold text-primary">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <nav class="mobile-nav">
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <a th:href="@{/}" class="text-decoration-none text-dark fw-semibold d-block py-2">
                            <i class="bi bi-house me-2"></i>Trang chủ
                        </a>
                    </li>
                    <li class="mb-3">
                        <a th:href="@{/products}" class="text-decoration-none text-dark fw-semibold d-block py-2">
                            <i class="bi bi-grid me-2"></i>Sản phẩm
                        </a>
                        <ul class="list-unstyled ms-4 mt-2">
                            <li th:each="category : ${categories}">
                                <a th:href="@{/products(categoryId=${category.id})}" 
                                   class="text-decoration-none text-muted d-block py-1"
                                   th:text="${category.name}">Danh mục</a>
                            </li>
                        </ul>
                    </li>
                    <li class="mb-3">
                        <a href="#" class="text-decoration-none text-dark fw-semibold d-block py-2">
                            <i class="bi bi-info-circle me-2"></i>Giới thiệu
                        </a>
                    </li>
                    <li class="mb-3">
                        <a href="#" class="text-decoration-none text-dark fw-semibold d-block py-2">
                            <i class="bi bi-newspaper me-2"></i>Tin tức
                        </a>
                    </li>
                    <li class="mb-3">
                        <a href="#" class="text-decoration-none text-dark fw-semibold d-block py-2">
                            <i class="bi bi-telephone me-2"></i>Liên hệ
                        </a>
                    </li>
                </ul>
                
                <!-- Mobile User Actions -->
                <div class="border-top pt-3 mt-4">
                    <div sec:authorize="!isAuthenticated()">
                        <a th:href="@{/login}" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Đăng nhập
                        </a>
                        <a th:href="@{/register}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-person-plus me-2"></i>Đăng ký
                        </a>
                    </div>
                    <div sec:authorize="isAuthenticated()">
                        <div class="d-flex align-items-center mb-3">
                            <div class="avatar-circle-small me-2">
                                <span class="avatar-text-small fw-bold text-white" 
                                      th:text="${#strings.substring(#authentication.principal.fullName, 0, 1).toUpperCase()}">U</span>
                            </div>
                            <div>
                                <div class="fw-semibold" th:text="${#authentication.principal.fullName}">User</div>
                                <small class="text-muted">Khách hàng thân thiết</small>
                            </div>
                        </div>
                        <a th:href="@{/profile}" class="btn btn-outline-primary w-100 mb-2">
                            <i class="bi bi-person me-2"></i>Thông tin cá nhân
                        </a>
                        <a th:href="@{/orders}" class="btn btn-outline-success w-100 mb-2">
                            <i class="bi bi-bag me-2"></i>Đơn hàng của tôi
                        </a>
                        <form th:action="@{/logout}" method="post">
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
                            </button>
                        </form>
                    </div>
                </div>
            </nav>
        </div>
    </div>
</body>
</html>