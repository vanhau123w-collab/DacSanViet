<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <!-- This head section will be replaced by the including page -->
</head>
<body>
    <!-- Modern Header Fragment -->
    <header th:fragment="navbar" class="modern-header bg-white shadow-sm">
        <div class="container">
            <div class="row align-items-center py-2">
                <!-- Logo -->
                <div class="col-lg-3 col-md-4 col-6">
                    <a th:href="@{/}" class="logo-brand d-flex align-items-center text-decoration-none">
                        <!-- Desktop Logo -->
                        <img src="https://files.catbox.moe/4ka4id.webp" 
                             alt="Đặc Sản Việt" 
                             class="logo-image logo-desktop">
                        <!-- Mobile Logo -->
                        <img src="https://files.catbox.moe/c373f9.webp" 
                             alt="Đặc Sản Việt" 
                             class="logo-image logo-mobile">
                    </a>
                </div>
                
                <!-- Navigation Menu -->
                <div class="col-lg-6 col-md-4 d-none d-lg-block">
                    <nav class="main-nav">
                        <ul class="nav-menu d-flex justify-content-center list-unstyled mb-0">
                            <li class="nav-item me-4">
                                <a th:href="@{/}" class="nav-link text-dark fw-semibold position-relative">
                                    Trang chủ
                                </a>
                            </li>
                            <li class="nav-item dropdown me-4">
                                <a href="#" class="nav-link text-dark fw-semibold position-relative" 
                                   data-bs-toggle="dropdown" aria-expanded="false">
                                    Sản Phẩm
                                    <i class="fas fa-chevron-down ms-1" style="font-size: 0.75rem;"></i>
                                </a>
                                <ul class="dropdown-menu mega-menu border-0 shadow-lg">
                                    <!-- Dynamic Categories from Database -->
                                    <th:block th:each="category, iterStat : ${headerCategories}">
                                        <!-- Category with children (has submenu) -->
                                        <li class="dropdown-submenu" th:if="${!category.children.isEmpty()}">
                                            <a class="dropdown-item py-2 d-flex align-items-center justify-content-between" href="#">
                                                <span>
                                                    <i class="fas fa-folder text-primary me-2" 
                                                       th:classappend="${iterStat.index == 0 ? 'fa-mountain' : (iterStat.index == 1 ? 'fa-sun' : 'fa-leaf')}"
                                                       th:style="${iterStat.index == 0 ? 'color: #007bff !important;' : (iterStat.index == 1 ? 'color: #ffc107 !important;' : 'color: #17a2b8 !important;')}"></i>
                                                    <span th:text="${category.name}">Category Name</span>
                                                </span>
                                                <i class="fas fa-chevron-right ms-2"></i>
                                            </a>
                                            <ul class="dropdown-menu submenu-items">
                                                <li th:each="child : ${category.children}">
                                                    <!-- Child with grandchildren (3rd level) -->
                                                    <div th:if="${!child.children.isEmpty()}" class="dropdown-submenu">
                                                        <a class="dropdown-item py-1 d-flex align-items-center justify-content-between" href="#">
                                                            <span>
                                                                <i class="fas fa-folder-open me-2" style="font-size: 0.85rem; color: #ffc107;"></i>
                                                                <span th:text="${child.name}">Subcategory</span>
                                                            </span>
                                                            <i class="fas fa-chevron-right ms-2" style="font-size: 0.75rem;"></i>
                                                        </a>
                                                        <ul class="dropdown-menu submenu-items submenu-level-3">
                                                            <li th:each="grandchild : ${child.children}">
                                                                <a class="dropdown-item py-1" th:href="@{/products(categoryId=${grandchild.id})}">
                                                                    <i class="fas fa-angle-right me-2" style="font-size: 0.75rem; color: #28a745;"></i>
                                                                    <span th:text="${grandchild.name}">Item</span>
                                                                </a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                    <!-- Child without grandchildren (leaf node) -->
                                                    <a th:if="${child.children.isEmpty()}" 
                                                       class="dropdown-item py-1" 
                                                       th:href="@{/products(categoryId=${child.id})}">
                                                        <i class="fas fa-circle me-2" style="font-size: 0.5rem;"
                                                           th:style="${iterStat.index == 0 ? 'color: #28a745;' : (iterStat.index == 1 ? 'color: #ffc107;' : 'color: #17a2b8;')}"></i>
                                                        <span th:text="${child.name}">Subcategory</span>
                                                    </a>
                                                </li>
                                            </ul>
                                        </li>
                                        <!-- Category without children -->
                                        <li th:if="${category.children.isEmpty()}">
                                            <a class="dropdown-item py-2" th:href="@{/products(categoryId=${category.id})}">
                                                <i class="fas fa-tag text-success me-2"></i>
                                                <span th:text="${category.name}">Category Name</span>
                                            </a>
                                        </li>
                                    </th:block>
                                    
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item py-2" th:href="@{/products}">
                                        <i class="fas fa-th text-success me-2"></i>Tất Cả Sản Phẩm
                                    </a></li>
                                </ul>
                            </li>
                            <li class="nav-item me-4">
                                <a th:href="@{/about}" class="nav-link text-dark fw-semibold position-relative">
                                    Giới thiệu
                                </a>
                            </li>
                            <li class="nav-item me-4">
                                <a th:href="@{/news}" class="nav-link text-dark fw-semibold position-relative">
                                    Tin tức
                                </a>
                            </li>
                            <li class="nav-item">
                                <a th:href="@{/contact}" class="nav-link text-dark fw-semibold position-relative">
                                    Liên hệ
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
                
                <!-- Right Side Actions -->
                <div class="col-lg-3 col-md-4 col-6">
                    <div class="header-actions d-flex align-items-center justify-content-end">
                        <!-- Cart Icon -->
                        <div class="cart-icon-wrapper position-relative me-3">
                            <a th:href="@{/cart}" class="cart-icon text-decoration-none d-block position-relative">
                                <i class="bi bi-bag fs-4 text-dark"></i>
                            </a>
                            <span class="cart-badge position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" 
                                  style="font-size: 0.65rem; padding: 0.25rem 0.5rem; min-width: 20px; height: 20px; line-height: 1; display: none; align-items: center; justify-content: center;">0</span>
                        </div>
                        
                        <!-- Inline script to immediately update cart badge -->
                        <script>
                            (function() {
                                function updateCartBadgeNow() {
                                    try {
                                        const cart = localStorage.getItem('shopping_cart');
                                        const cartData = cart ? JSON.parse(cart) : { items: [] };
                                        const count = cartData.items.reduce((total, item) => total + (item.quantity || 0), 0);
                                        
                                        console.log('Updating cart badge - count:', count, 'cart items:', cartData.items.length);
                                        
                                        const badges = document.querySelectorAll('.cart-badge');
                                        badges.forEach(badge => {
                                            if (count > 0) {
                                                badge.textContent = count;
                                                badge.style.display = 'flex';
                                                badge.style.visibility = 'visible';
                                                badge.style.opacity = '1';
                                            } else {
                                                badge.textContent = '0';
                                                badge.style.display = 'none';
                                                badge.style.visibility = 'hidden';
                                                badge.style.opacity = '0';
                                            }
                                        });
                                    } catch (e) {
                                        console.error('Error updating cart badge:', e);
                                    }
                                }
                                
                                // Run immediately
                                updateCartBadgeNow();
                                
                                // Run when DOM is ready
                                if (document.readyState === 'loading') {
                                    document.addEventListener('DOMContentLoaded', updateCartBadgeNow);
                                } else {
                                    updateCartBadgeNow();
                                }
                                
                                // CRITICAL: Run on pageshow (back button) - this must work!
                                window.addEventListener('pageshow', function(event) {
                                    console.log('pageshow event - persisted:', event.persisted);
                                    updateCartBadgeNow();
                                });
                                
                                // Run on storage change
                                window.addEventListener('storage', function(e) {
                                    if (e.key === 'shopping_cart') {
                                        console.log('storage event - cart changed');
                                        updateCartBadgeNow();
                                    }
                                });
                                
                                // Run on focus
                                window.addEventListener('focus', function() {
                                    console.log('window focus - updating cart');
                                    updateCartBadgeNow();
                                });
                                
                                // Run on visibilitychange
                                document.addEventListener('visibilitychange', function() {
                                    if (!document.hidden) {
                                        console.log('page visible - updating cart');
                                        updateCartBadgeNow();
                                    }
                                });
                                
                                // Polling as last resort - check every 2 seconds when page is visible
                                setInterval(function() {
                                    if (!document.hidden) {
                                        updateCartBadgeNow();
                                    }
                                }, 2000);
                            })();
                        </script>
                        
                        <!-- User Avatar/Login -->
                        <div class="user-section">
                            <!-- Authenticated User -->
                            <div sec:authorize="isAuthenticated()" class="dropdown">
                                <a href="#" class="user-avatar text-decoration-none d-flex align-items-center" 
                                   data-bs-toggle="dropdown" aria-expanded="false">
                                    <div class="avatar-circle d-flex align-items-center justify-content-center me-2">
                                        <span class="avatar-text fw-bold text-white" 
                                              th:text="${#strings.substring(#authentication.principal.fullName != null ? #authentication.principal.fullName : #authentication.name, 0, 1).toUpperCase()}">U</span>
                                    </div>
                                    <span class="text-dark d-none d-md-inline" style="font-size: 0.9rem;">
                                        Xin chào, <strong th:text="${#authentication.principal.fullName}">User</strong>
                                    </span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg">
                                    <li class="dropdown-header">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle-small me-2">
                                                <span class="avatar-text-small fw-bold text-white" 
                                                      th:text="${#strings.substring(#authentication.principal.fullName, 0, 1).toUpperCase()}">U</span>
                                            </div>
                                            <div>
                                                <div class="fw-semibold" th:text="${#authentication.principal.fullName}">User</div>
                                            </div>
                                        </div>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item py-2" th:href="@{/profile}">
                                        <i class="fas fa-user me-2 text-primary"></i>Thông tin cá nhân
                                    </a></li>
                                    <li><a class="dropdown-item py-2" th:href="@{/orders}">
                                        <i class="fas fa-shopping-bag me-2 text-success"></i>Đơn hàng của tôi
                                    </a></li>
                                    <li><a class="dropdown-item py-2" th:href="@{/cart}">
                                        <i class="fas fa-shopping-cart me-2 text-warning"></i>Giỏ hàng
                                    </a></li>
                                    <li sec:authorize="hasAnyRole('ADMIN', 'STAFF')">
                                        <a class="dropdown-item py-2" th:href="@{/admin/dashboard}">
                                            <i class="fas fa-tachometer-alt me-2 text-info"></i>Quản trị hệ thống
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form th:action="@{/logout}" method="post" class="d-inline w-100">
                                            <button type="submit" class="dropdown-item py-2 text-danger">
                                                <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                            
                            <!-- Anonymous User -->
                            <div sec:authorize="!isAuthenticated()" class="login-section d-flex align-items-center">
                                <a th:href="@{/login}" class="btn btn-outline-primary btn-sm me-2" style="white-space: nowrap;">
                                    <i class="fas fa-sign-in-alt me-1"></i>Đăng nhập
                                </a>
                                <a th:href="@{/register}" class="btn btn-primary btn-sm d-none d-md-inline-block" style="white-space: nowrap;">
                                    <i class="fas fa-user-plus me-1"></i>Đăng ký
                                </a>
                            </div>
                        </div>
                        
                        <!-- Mobile Menu Toggle -->
                        <button class="mobile-menu-toggle btn btn-outline-secondary d-lg-none ms-2" 
                                type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Mobile Menu Offcanvas Fragment -->
    <div th:fragment="mobile-menu" class="offcanvas offcanvas-end" tabindex="-1" id="mobileMenu">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title fw-bold text-primary">Menu</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <nav class="mobile-nav">
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <a th:href="@{/}" class="text-decoration-none text-dark fw-semibold d-block py-2">
                            <i class="fas fa-home me-2"></i>Trang chủ
                        </a>
                    </li>
                    <li class="mb-3">
                        <a th:href="@{/products}" class="text-decoration-none text-dark fw-semibold d-block py-2">
                            <i class="fas fa-th me-2"></i>Sản phẩm
                        </a>
                        <ul class="list-unstyled ms-4 mt-2">
                            <li class="mb-2">
                                <strong class="text-primary">
                                    <i class="fas fa-mountain me-2"></i>Miền Bắc
                                </strong>
                                <ul class="list-unstyled ms-3 mt-1">
                                    <li><a th:href="@{/products(region='bac',category='banh-chung')}" 
                                           class="text-decoration-none text-muted d-block py-1">Bánh Chưng</a></li>
                                    <li><a th:href="@{/products(region='bac',category='pho-bo')}" 
                                           class="text-decoration-none text-muted d-block py-1">Phở Bò Hà Nội</a></li>
                                    <li><a th:href="@{/products(region='bac',category='com-lang')}" 
                                           class="text-decoration-none text-muted d-block py-1">Cốm Làng Vòng</a></li>
                                </ul>
                            </li>
                            <li class="mb-2">
                                <strong class="text-warning">
                                    <i class="fas fa-sun me-2"></i>Miền Trung
                                </strong>
                                <ul class="list-unstyled ms-3 mt-1">
                                    <li><a th:href="@{/products(region='trung',category='bun-bo-hue')}" 
                                           class="text-decoration-none text-muted d-block py-1">Bún Bò Huế</a></li>
                                    <li><a th:href="@{/products(region='trung',category='mi-quang')}" 
                                           class="text-decoration-none text-muted d-block py-1">Mì Quảng</a></li>
                                    <li><a th:href="@{/products(region='trung',category='cao-lau')}" 
                                           class="text-decoration-none text-muted d-block py-1">Cao Lầu</a></li>
                                </ul>
                            </li>
                            <li class="mb-2">
                                <strong class="text-info">
                                    <i class="fas fa-leaf me-2"></i>Miền Nam
                                </strong>
                                <ul class="list-unstyled ms-3 mt-1">
                                    <li><a th:href="@{/products(region='nam',category='banh-tet')}" 
                                           class="text-decoration-none text-muted d-block py-1">Bánh Tét</a></li>
                                    <li><a th:href="@{/products(region='nam',category='banh-xeo')}" 
                                           class="text-decoration-none text-muted d-block py-1">Bánh Xèo</a></li>
                                    <li><a th:href="@{/products(region='nam',category='mit-say')}" 
                                           class="text-decoration-none text-muted d-block py-1">Mít Sấy</a></li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li class="mb-3">
                        <a th:href="@{/about}" class="text-decoration-none text-dark fw-semibold d-block py-2">
                            <i class="fas fa-info-circle me-2"></i>Giới thiệu
                        </a>
                    </li>
                    <li class="mb-3">
                        <a th:href="@{/news}" class="text-decoration-none text-dark fw-semibold d-block py-2">
                            <i class="fas fa-newspaper me-2"></i>Tin tức
                        </a>
                    </li>
                    <li class="mb-3">
                        <a th:href="@{/contact}" class="text-decoration-none text-dark fw-semibold d-block py-2">
                            <i class="fas fa-phone me-2"></i>Liên hệ
                        </a>
                    </li>
                </ul>
                
                <!-- Mobile User Actions -->
                <div class="border-top pt-3 mt-4">
                    <div sec:authorize="!isAuthenticated()">
                        <a th:href="@{/login}" class="btn btn-primary w-100 mb-2">
                            <i class="fas fa-sign-in-alt me-2"></i>Đăng nhập
                        </a>
                        <a th:href="@{/register}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-user-plus me-2"></i>Đăng ký
                        </a>
                    </div>
                    <div sec:authorize="isAuthenticated()">
                        <div class="d-flex align-items-center mb-3">
                            <div class="avatar-circle-small me-2">
                                <span class="avatar-text-small fw-bold text-white" 
                                      th:text="${#strings.substring(#authentication.principal.fullName, 0, 1).toUpperCase()}">U</span>
                            </div>
                            <div>
                                <div class="fw-semibold" th:text="${#authentication.principal.fullName}">User</div>
                                <small class="text-muted">Khách hàng thân thiết</small>
                            </div>
                        </div>
                        <a th:href="@{/profile}" class="btn btn-outline-primary w-100 mb-2">
                            <i class="fas fa-user me-2"></i>Thông tin cá nhân
                        </a>
                        <a th:href="@{/orders}" class="btn btn-outline-success w-100 mb-2">
                            <i class="fas fa-shopping-bag me-2"></i>Đơn hàng của tôi
                        </a>
                        <form th:action="@{/logout}" method="post">
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                            </button>
                        </form>
                    </div>
                </div>
            </nav>
        </div>
    </div>
</body>

<!-- CSS cho Mega Menu và Submenu -->
<style>
/* Mega Menu Styles */
.mega-menu {
    min-width: 280px;
    padding: 10px 0;
}

/* Dropdown Submenu Styles */
.dropdown-submenu {
    position: relative;
}

/* CRITICAL: Hide submenu by default */
.dropdown-submenu > .dropdown-menu.submenu-items {
    top: 0;
    left: 100%;
    margin-top: -1px;
    min-width: 250px;
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    border: 1px solid #e9ecef;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    position: absolute;
    background: white;
    border-radius: 0 0 12px 12px;
    padding: 8px 0;
    z-index: 10002;
    transform: translateX(-10px);
    transition: all 0.3s ease;
}

/* Show submenu ONLY when hovering its direct parent */
.dropdown-submenu:hover > .dropdown-menu.submenu-items {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    transform: translateX(0);
    animation: slideInRight 0.3s ease;
}

/* Hover effects for parent items */
.dropdown-submenu > .dropdown-item:hover {
    background: rgba(78, 194, 182, 0.1) !important;
    color: #2e857c !important;
}

/* Hover effects for submenu items */
.submenu-items .dropdown-item:hover {
    background: rgba(78, 194, 182, 0.15) !important;
    color: #2e857c !important;
    transform: translateX(8px);
    transition: all 0.3s ease;
}

/* Animation */
@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(-10px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Mobile responsive */
@media (max-width: 991px) {
    .dropdown-submenu > .dropdown-menu {
        position: static;
        float: none;
        width: auto;
        margin-top: 0;
        background-color: #f8f9fa;
        border: none;
        box-shadow: none;
        display: none;
    }
    
    .dropdown-submenu:hover > .dropdown-menu {
        display: block;
    }
    
    .submenu-items .dropdown-item {
        padding-left: 2rem;
    }
}

/* Icon animations */
.dropdown-submenu > .dropdown-item i.fa-chevron-right {
    transition: transform 0.3s ease;
}

.dropdown-submenu:hover > .dropdown-item i.fa-chevron-right {
    transform: translateX(3px);
}

/* Color coding for regions - parent items only */
.dropdown-submenu:nth-child(1) > .dropdown-item:hover {
    background: rgba(0, 123, 255, 0.1) !important;
    color: #007bff !important;
}

.dropdown-submenu:nth-child(2) > .dropdown-item:hover {
    background: rgba(255, 193, 7, 0.1) !important;
    color: #e0a800 !important;
}

.dropdown-submenu:nth-child(3) > .dropdown-item:hover {
    background: rgba(23, 162, 184, 0.1) !important;
    color: #17a2b8 !important;
}
</style>

</html>