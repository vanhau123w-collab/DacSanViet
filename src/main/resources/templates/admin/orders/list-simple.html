<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đơn Hàng - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-danger">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-shop me-2"></i>Đặc Sản Quê Hương - Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin/dashboard">Dashboard</a>
                <a class="nav-link" href="/admin/orders">Đơn hàng</a>
                <a class="nav-link" href="/">Về trang chính</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-6">
                <a href="/admin/dashboard" class="btn btn-outline-primary me-2">
                    <i class="bi bi-arrow-left me-1"></i>Về Dashboard
                </a>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-list-ul me-2"></i>Danh Sách Đơn Hàng
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
                        
                        <div th:if="${orders != null and !orders.empty}">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Mã đơn hàng</th>
                                            <th>Khách hàng</th>
                                            <th>Ngày đặt</th>
                                            <th>Trạng thái</th>
                                            <th>Phương thức thanh toán</th>
                                            <th>Tổng tiền</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="order : ${orders}">
                                            <td th:text="${order.orderNumber ?: order.id}">#123</td>
                                            <td th:text="${order.userFullName ?: 'Unknown User'}">Customer</td>
                                            <td th:text="${order.orderDate != null ? #temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm') : 'N/A'}">Date</td>
                                            <td>
                                                <span class="badge bg-primary" th:text="${order.status}">Status</span>
                                            </td>
                                            <td>
                                                <span th:if="${order.paymentMethod == 'COD'}" class="text-success">
                                                    <i class="bi bi-cash-coin me-1"></i>COD
                                                </span>
                                                <span th:unless="${order.paymentMethod == 'COD'}" th:text="${order.paymentMethod ?: 'N/A'}">Other</span>
                                                <!-- Debug info -->
                                                <small class="text-muted d-block" th:text="'Debug: ' + ${order.paymentMethod}"></small>
                                            </td>
                                            <td th:text="${order.totalAmount != null ? #numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT') + '₫' : '0₫'}">100,000₫</td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a th:href="@{/admin/orders/{id}(id=${order.id})}" class="btn btn-sm btn-outline-primary">
                                                        <i class="bi bi-eye"></i> Xem
                                                    </a>
                                                    <!-- COD Approval Button - Only show for actual COD orders -->
                                                    <button th:if="${order.status != null and (order.status == T(com.specialtyfood.model.OrderStatus).PROCESSING or order.status == T(com.specialtyfood.model.OrderStatus).PENDING) and order.paymentMethod == 'COD'}" 
                                                            class="btn btn-sm btn-success"
                                                            th:onclick="'showCODApprovalModal(' + ${order.id} + ', \'' + ${order.orderNumber ?: order.id} + '\')'">
                                                        <i class="bi bi-check-circle"></i> Phê duyệt COD
                                                    </button>
                                                    <!-- Show COD button for testing -->
                                                    <button th:if="${order.status != null and (order.status == T(com.specialtyfood.model.OrderStatus).PROCESSING or order.status == T(com.specialtyfood.model.OrderStatus).PENDING)}" 
                                                            class="btn btn-sm btn-warning"
                                                            th:onclick="'testCODApproval(' + ${order.id} + ', \'' + ${order.orderNumber ?: order.id} + '\')'">
                                                        <i class="bi bi-bug"></i> Test COD
                                                    </button>
                                                </div>
                                                <!-- Debug info -->
                                                <small th:if="${order.status != null and (order.status == T(com.specialtyfood.model.OrderStatus).PROCESSING or order.status == T(com.specialtyfood.model.OrderStatus).PENDING)}" 
                                                       class="text-muted d-block mt-1" 
                                                       th:text="'Status: ' + ${order.status} + ', Payment: [' + ${order.paymentMethod ?: 'null'} + ']'"></small>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination -->
                            <nav th:if="${orders.totalPages > 1}">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item" th:classappend="${orders.first} ? 'disabled'">
                                        <a class="page-link" th:href="@{/admin/orders(page=${orders.number - 1})}">Previous</a>
                                    </li>
                                    <li class="page-item" th:each="i : ${#numbers.sequence(0, orders.totalPages - 1)}" 
                                        th:classappend="${i == orders.number} ? 'active'">
                                        <a class="page-link" th:href="@{/admin/orders(page=${i})}" th:text="${i + 1}">1</a>
                                    </li>
                                    <li class="page-item" th:classappend="${orders.last} ? 'disabled'">
                                        <a class="page-link" th:href="@{/admin/orders(page=${orders.number + 1})}">Next</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                        
                        <div th:if="${orders == null or orders.empty}" class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">Chưa có đơn hàng nào</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- COD Approval Modal -->
    <div id="codApprovalModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Phê Duyệt Đơn Hàng COD</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Đơn hàng: <span id="modalOrderNumber" class="fw-bold"></span></p>
                    
                    <div class="mb-3">
                        <label for="shippingCarrier" class="form-label">Chọn nhà vận chuyển:</label>
                        <select id="shippingCarrier" class="form-select">
                            <option value="">-- Chọn nhà vận chuyển --</option>
                            <option value="GIAO_HANG_NHANH">Giao Hàng Nhanh</option>
                            <option value="GIAO_HANG_TIET_KIEM">Giao Hàng Tiết Kiệm</option>
                            <option value="VIETTEL_POST">Viettel Post</option>
                            <option value="VIETNAM_POST">Vietnam Post</option>
                            <option value="J_T_EXPRESS">J&T Express</option>
                            <option value="SHOPEE_EXPRESS">Shopee Express</option>
                            <option value="BEST_EXPRESS">Best Express</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="trackingNumber" class="form-label">Mã vận đơn (tùy chọn):</label>
                        <input type="text" id="trackingNumber" class="form-control" placeholder="Nhập mã vận đơn nếu có">
                    </div>
                    
                    <div class="mb-3">
                        <label for="approvalNotes" class="form-label">Ghi chú:</label>
                        <textarea id="approvalNotes" rows="3" class="form-control" placeholder="Ghi chú thêm về việc phê duyệt..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-success" onclick="confirmCODApproval()">
                        <i class="bi bi-check-circle me-1"></i>Phê Duyệt
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentOrderId = null;
        let codModal = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            codModal = new bootstrap.Modal(document.getElementById('codApprovalModal'));
        });
        
        function showCODApprovalModal(orderId, orderNumber) {
            currentOrderId = orderId;
            document.getElementById('modalOrderNumber').textContent = orderNumber;
            
            // Reset form
            document.getElementById('shippingCarrier').value = '';
            document.getElementById('trackingNumber').value = '';
            document.getElementById('approvalNotes').value = '';
            
            codModal.show();
        }
        
        function confirmCODApproval() {
            const shippingCarrier = document.getElementById('shippingCarrier').value;
            const trackingNumber = document.getElementById('trackingNumber').value;
            const notes = document.getElementById('approvalNotes').value;
            
            if (!shippingCarrier) {
                alert('Vui lòng chọn nhà vận chuyển!');
                return;
            }
            
            const requestData = {
                shippingCarrier: shippingCarrier,
                trackingNumber: trackingNumber || null,
                notes: notes || `Đơn hàng COD đã được phê duyệt và giao cho ${getCarrierName(shippingCarrier)}`
            };
            
            fetch(`/api/admin/orders/${currentOrderId}/approve-cod`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Đơn hàng COD đã được phê duyệt và giao cho ${getCarrierName(shippingCarrier)}!`);
                    codModal.hide();
                    location.reload();
                } else {
                    alert('Lỗi: ' + (data.message || 'Không thể phê duyệt đơn hàng'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi phê duyệt đơn hàng COD');
            });
        }
        
        function getCarrierName(carrierCode) {
            const carriers = {
                'GIAO_HANG_NHANH': 'Giao Hàng Nhanh',
                'GIAO_HANG_TIET_KIEM': 'Giao Hàng Tiết Kiệm',
                'VIETTEL_POST': 'Viettel Post',
                'VIETNAM_POST': 'Vietnam Post',
                'J_T_EXPRESS': 'J&T Express',
                'SHOPEE_EXPRESS': 'Shopee Express',
                'BEST_EXPRESS': 'Best Express'
            };
            return carriers[carrierCode] || carrierCode;
        }
        
        function testCODApproval(orderId, orderNumber) {
            // Test function to check COD approval regardless of payment method
            const requestData = {
                shippingCarrier: 'GIAO_HANG_NHANH',
                trackingNumber: 'TEST123',
                notes: 'Test COD approval'
            };
            
            fetch(`/api/admin/orders/${orderId}/approve-cod`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                alert('Test result: ' + JSON.stringify(data));
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Test error: ' + error);
            });
        }
    </script>
</body>
</html>