<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>Chi Tiết Khách Hàng - Đặc Sản Quê Hương</title>
</head>
<body>
    <th:block layout:fragment="content">
        <div class="container-fluid py-4">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="fw-bold">
                                <i class="bi bi-person-circle me-2"></i>Chi Tiết Khách Hàng
                            </h1>
                            <p class="text-muted">Thông tin chi tiết và lịch sử hoạt động</p>
                        </div>
                        <div>
                            <a th:href="@{/admin/customers}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Về Danh Sách
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Customer Information -->
                <div class="col-lg-4">
                    <!-- Profile Card -->
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                                 style="width: 80px; height: 80px;">
                                <i class="bi bi-person fs-1"></i>
                            </div>
                            <h4 class="mb-1" th:text="${customer.fullName}">Customer Name</h4>
                            <p class="text-muted mb-3" th:text="${customer.email}">email@example.com</p>
                            
                            <div class="row text-center mb-3">
                                <div class="col">
                                    <span class="badge fs-6" 
                                          th:classappend="${customer.active} ? 'bg-success' : 'bg-danger'"
                                          th:text="${customer.active} ? 'Hoạt động' : 'Bị khóa'">Status</span>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn" 
                                        th:classappend="${customer.active} ? 'btn-warning' : 'btn-success'"
                                        th:text="${customer.active} ? 'Khóa Tài Khoản' : 'Kích Hoạt Tài Khoản'"
                                        onclick="toggleCustomerStatus()">Toggle Status</button>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-telephone me-2"></i>Thông Tin Liên Hệ
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label text-muted">Email</label>
                                <div th:text="${customer.email}">email@example.com</div>
                            </div>
                            <div class="mb-3" th:if="${customer.phoneNumber != null}">
                                <label class="form-label text-muted">Số điện thoại</label>
                                <div th:text="${customer.phoneNumber}">+84 123 456 789</div>
                            </div>
                            <div class="mb-0">
                                <label class="form-label text-muted">Ngày đăng ký</label>
                                <div th:text="${#temporals.format(customer.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:30</div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Statistics -->
                    <div class="card mt-4" th:if="${customerStats != null}">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-graph-up me-2"></i>Thống Kê
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6 mb-3">
                                    <div class="border-end">
                                        <h4 class="text-primary mb-0" th:text="${customerStats.totalOrders ?: 0}">0</h4>
                                        <small class="text-muted">Tổng đơn hàng</small>
                                    </div>
                                </div>
                                <div class="col-6 mb-3">
                                    <h4 class="text-success mb-0" th:text="${customerStats.totalSpent != null ? #numbers.formatCurrency(customerStats.totalSpent) : '0 ₫'}">0 ₫</h4>
                                    <small class="text-muted">Tổng chi tiêu</small>
                                </div>
                            </div>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="border-end">
                                        <h4 class="text-info mb-0" th:text="${customerStats.completedOrders ?: 0}">0</h4>
                                        <small class="text-muted">Đã hoàn thành</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <h4 class="text-warning mb-0" th:text="${customerStats.cancelledOrders ?: 0}">0</h4>
                                    <small class="text-muted">Đã hủy</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order History -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-clock-history me-2"></i>Lịch Sử Đơn Hàng
                            </h5>
                            <span class="badge bg-secondary" th:text="${#lists.size(recentOrders)}">0</span>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Mã ĐH</th>
                                            <th>Ngày Đặt</th>
                                            <th>Trạng Thái</th>
                                            <th>Tổng Tiền</th>
                                            <th>Thao Tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="order : ${recentOrders}">
                                            <td>
                                                <strong>#<span th:text="${order.id}">123</span></strong>
                                            </td>
                                            <td>
                                                <div th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy')}">01/01/2024</div>
                                                <small class="text-muted" th:text="${#temporals.format(order.orderDate, 'HH:mm')}">10:30</small>
                                            </td>
                                            <td>
                                                <span class="badge" 
                                                      th:classappend="${order.status.name() == 'PENDING' ? 'bg-warning' : 
                                                                       order.status.name() == 'CONFIRMED' ? 'bg-info' : 
                                                                       order.status.name() == 'SHIPPED' ? 'bg-primary' : 
                                                                       order.status.name() == 'DELIVERED' ? 'bg-success' : 'bg-danger'}"
                                                      th:text="${order.status.name() == 'PENDING' ? 'Chờ xác nhận' : 
                                                                order.status.name() == 'CONFIRMED' ? 'Đã xác nhận' : 
                                                                order.status.name() == 'SHIPPED' ? 'Đang giao' : 
                                                                order.status.name() == 'DELIVERED' ? 'Đã giao' : 'Đã hủy'}">Status</span>
                                            </td>
                                            <td>
                                                <strong th:text="${#numbers.formatCurrency(order.totalAmount)}">$0.00</strong>
                                            </td>
                                            <td>
                                                <a th:href="@{/admin/orders/{id}(id=${order.id})}" 
                                                   class="btn btn-sm btn-outline-primary" title="Xem chi tiết">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        <tr th:if="${recentOrders.empty}">
                                            <td colspan="5" class="text-center py-4 text-muted">
                                                <i class="bi bi-inbox me-2"></i>Khách hàng chưa có đơn hàng nào
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer" th:if="${!recentOrders.empty}">
                            <div class="text-center">
                                <a th:href="@{/admin/customers/{id}/orders(id=${customer.id})}" class="btn btn-outline-primary">
                                    <i class="bi bi-eye me-2"></i>Xem Tất Cả Đơn Hàng
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Addresses -->
                    <div class="card mt-4" th:if="${customer.addresses != null and !customer.addresses.empty}">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-geo-alt me-2"></i>Địa Chỉ Giao Hàng
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6" th:each="address : ${customer.addresses}">
                                    <div class="border rounded p-3 mb-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-0" th:text="${address.recipientName}">Recipient Name</h6>
                                            <span class="badge bg-primary" th:if="${address.isDefault}">Mặc định</span>
                                        </div>
                                        <address class="mb-2">
                                            <span th:text="${address.streetAddress}">Street Address</span><br>
                                            <span th:text="${address.ward + ', ' + address.district}">Ward, District</span><br>
                                            <span th:text="${address.city + ', ' + address.province}">City, Province</span><br>
                                            <i class="bi bi-telephone me-1"></i><span th:text="${address.phoneNumber}">Phone</span>
                                        </address>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </th:block>

    <th:block layout:fragment="scripts-extra">
        <script>
            function toggleCustomerStatus() {
                const customerId = [[${customer.id}]];
                const currentStatus = [[${customer.active}]];
                const action = currentStatus ? 'khóa' : 'kích hoạt';
                
                if (confirm(`Bạn có chắc chắn muốn ${action} tài khoản khách hàng này?`)) {
                    fetch(`/api/admin/customers/${customerId}/toggle-status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert(`Có lỗi xảy ra khi ${action} tài khoản khách hàng`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert(`Có lỗi xảy ra khi ${action} tài khoản khách hàng`);
                    });
                }
            }
        </script>
    </th:block>
</body>
</html>