<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>Báo Cáo Doanh Thu - Đặc Sản Quê Hương</title>
</head>
<body>
    <th:block layout:fragment="content">
        <div class="container-fluid py-4">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="fw-bold">
                                <i class="bi bi-graph-up me-2"></i>Báo Cáo Doanh Thu
                            </h1>
                            <p class="text-muted">Phân tích và thống kê kinh doanh</p>
                        </div>
                        <div>
                            <a th:href="@{/admin/dashboard}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Về Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Date Range Filter -->
            <div class="card mb-4">
                <div class="card-body">
                    <form th:action="@{/admin/reports}" method="get" class="row g-3">
                        <div class="col-md-3">
                            <label for="startDate" class="form-label">Từ ngày</label>
                            <input type="date" class="form-control" id="startDate" name="startDate" th:value="${startDate}">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label">Đến ngày</label>
                            <input type="date" class="form-control" id="endDate" name="endDate" th:value="${endDate}">
                        </div>
                        <div class="col-md-3">
                            <label for="period" class="form-label">Chu kỳ</label>
                            <select class="form-select" id="period" name="period">
                                <option value="DAILY" th:selected="${period == 'DAILY'}">Theo ngày</option>
                                <option value="WEEKLY" th:selected="${period == 'WEEKLY'}">Theo tuần</option>
                                <option value="MONTHLY" th:selected="${period == 'MONTHLY'}">Theo tháng</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search me-2"></i>Tạo Báo Cáo
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Revenue Overview -->
            <div class="row g-4 mb-4" th:if="${salesReport != null}">
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-1">Tổng Doanh Thu</h6>
                                    <h3 class="mb-0" th:text="${salesReport.revenueAnalytics != null ? #numbers.formatCurrency(salesReport.revenueAnalytics.totalRevenue) : '0 ₫'}">0 ₫</h3>
                                    <small class="opacity-75">Trong khoảng thời gian</small>
                                </div>
                                <div class="fs-1 opacity-75">
                                    <i class="bi bi-currency-dollar"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-1">Tổng Đơn Hàng</h6>
                                    <h3 class="mb-0" th:text="${salesReport.revenueAnalytics != null ? salesReport.revenueAnalytics.totalOrders : '0'}">0</h3>
                                    <small class="opacity-75">Đơn hàng hoàn thành</small>
                                </div>
                                <div class="fs-1 opacity-75">
                                    <i class="bi bi-bag-check"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-1">Giá Trị TB/Đơn</h6>
                                    <h3 class="mb-0" th:text="${salesReport.revenueAnalytics != null ? #numbers.formatCurrency(salesReport.revenueAnalytics.averageOrderValue) : '0 ₫'}">0 ₫</h3>
                                    <small class="opacity-75">Trung bình</small>
                                </div>
                                <div class="fs-1 opacity-75">
                                    <i class="bi bi-calculator"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title mb-1">Khách Hàng Mới</h6>
                                    <h3 class="mb-0" th:text="${salesReport.customerTrends != null ? salesReport.customerTrends.newCustomers : '0'}">0</h3>
                                    <small class="opacity-75">Trong kỳ</small>
                                </div>
                                <div class="fs-1 opacity-75">
                                    <i class="bi bi-person-plus"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4" th:if="${salesReport != null}">
                <!-- Popular Products -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-star me-2"></i>Sản Phẩm Bán Chạy
                            </h5>
                        </div>
                        <div class="card-body">
                            <div th:if="${salesReport.popularProducts != null and !salesReport.popularProducts.empty}">
                                <div class="d-flex align-items-center mb-3" th:each="product, iterStat : ${salesReport.popularProducts}" th:if="${iterStat.index < 10}">
                                    <div class="me-3">
                                        <span class="badge bg-primary rounded-pill" th:text="${iterStat.index + 1}">1</span>
                                    </div>
                                    <img th:src="${product.imageUrl != null ? product.imageUrl : '/images/placeholder-product.jpg'}" 
                                         class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;"
                                         th:alt="${product.name}">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0" th:text="${product.name}">Product Name</h6>
                                        <small class="text-muted">
                                            Đã bán: <span th:text="${product.soldQuantity ?: 0}">0</span> | 
                                            Doanh thu: <span th:text="${#numbers.formatCurrency(product.revenue ?: 0)}">0 ₫</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div th:if="${salesReport.popularProducts == null or salesReport.popularProducts.empty}" class="text-center py-3">
                                <i class="bi bi-box text-muted display-6"></i>
                                <p class="text-muted mt-2 mb-0">Chưa có dữ liệu</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Customers -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-people me-2"></i>Khách Hàng VIP
                            </h5>
                        </div>
                        <div class="card-body">
                            <div th:if="${salesReport.topCustomers != null and !salesReport.topCustomers.empty}">
                                <div class="d-flex align-items-center mb-3" th:each="customer, iterStat : ${salesReport.topCustomers}" th:if="${iterStat.index < 10}">
                                    <div class="me-3">
                                        <span class="badge bg-success rounded-pill" th:text="${iterStat.index + 1}">1</span>
                                    </div>
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 40px; height: 40px;">
                                        <i class="bi bi-person"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-0" th:text="${customer.fullName}">Customer Name</h6>
                                        <small class="text-muted">
                                            <span th:text="${customer.totalOrders ?: 0}">0</span> đơn hàng | 
                                            <span th:text="${#numbers.formatCurrency(customer.totalSpent ?: 0)}">0 ₫</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div th:if="${salesReport.topCustomers == null or salesReport.topCustomers.empty}" class="text-center py-3">
                                <i class="bi bi-people text-muted display-6"></i>
                                <p class="text-muted mt-2 mb-0">Chưa có dữ liệu</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Status Breakdown -->
            <div class="row g-4 mt-4" th:if="${salesReport != null and salesReport.orderStatusBreakdown != null}">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-pie-chart me-2"></i>Phân Tích Trạng Thái Đơn Hàng
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-2" th:each="status : ${salesReport.orderStatusBreakdown}">
                                    <div class="card border-0">
                                        <div class="card-body">
                                            <h4 class="mb-1" 
                                                th:classappend="${status.key == 'PENDING' ? 'text-warning' : 
                                                                 status.key == 'CONFIRMED' ? 'text-info' : 
                                                                 status.key == 'SHIPPED' ? 'text-primary' : 
                                                                 status.key == 'DELIVERED' ? 'text-success' : 'text-danger'}"
                                                th:text="${status.value}">0</h4>
                                            <p class="text-muted mb-0" 
                                               th:text="${status.key == 'PENDING' ? 'Chờ xác nhận' : 
                                                         status.key == 'CONFIRMED' ? 'Đã xác nhận' : 
                                                         status.key == 'SHIPPED' ? 'Đang giao' : 
                                                         status.key == 'DELIVERED' ? 'Đã giao' : 'Đã hủy'}">Status</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="row mt-4" th:if="${salesReport != null}">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-download me-2"></i>Xuất Báo Cáo
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="text-muted">Xuất báo cáo dưới các định dạng khác nhau để phân tích chi tiết hoặc lưu trữ.</p>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button type="button" class="btn btn-outline-success" onclick="exportReport('excel')">
                                            <i class="bi bi-file-earmark-excel me-2"></i>Excel
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" onclick="exportReport('pdf')">
                                            <i class="bi bi-file-earmark-pdf me-2"></i>PDF
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                                            <i class="bi bi-printer me-2"></i>In
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- No Data Message -->
            <div class="row" th:if="${salesReport == null}">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-graph-up display-1 text-muted"></i>
                            <h4 class="mt-3">Chọn Khoảng Thời Gian</h4>
                            <p class="text-muted">Vui lòng chọn khoảng thời gian để tạo báo cáo doanh thu</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </th:block>

    <th:block layout:fragment="scripts-extra">
        <script>
            function exportReport(format) {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const period = document.getElementById('period').value;
                
                const params = new URLSearchParams({
                    startDate: startDate,
                    endDate: endDate,
                    period: period,
                    format: format
                });
                
                // This would typically call an export endpoint
                alert(`Xuất báo cáo ${format.toUpperCase()} sẽ được triển khai trong phiên bản tiếp theo`);
            }
            
            // Set default dates if not set
            document.addEventListener('DOMContentLoaded', function() {
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                
                if (!startDateInput.value) {
                    const threeMonthsAgo = new Date();
                    threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                    startDateInput.value = threeMonthsAgo.toISOString().split('T')[0];
                }
                
                if (!endDateInput.value) {
                    const today = new Date();
                    endDateInput.value = today.toISOString().split('T')[0];
                }
            });
        </script>
    </th:block>
</body>
</html>