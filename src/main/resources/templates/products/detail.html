<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product != null ? product.name + ' - Đặc Sản Việt' : 'Chi Tiết Sản Phẩm'}">Chi Tiết Sản Phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/header.css(v=1)}">
    <link rel="stylesheet" th:href="@{/css/modern-ecommerce.css(v=1)}">
    <link rel="stylesheet" th:href="@{/css/product-detail.css(v=1)}">
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>
    <div th:replace="~{fragments/header :: mobile-menu}"></div>
    
    <div class="container py-5" th:if="${product != null}">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/}" class="text-teal"><i class="bi bi-house me-1"></i>Trang Chủ</a></li>
                <li class="breadcrumb-item"><a th:href="@{/products}" class="text-teal">Sản Phẩm</a></li>
                <li class="breadcrumb-item" th:if="${product.category != null}">
                    <a th:href="@{/products(categoryId=${product.categoryId})}" class="text-teal" th:text="${product.categoryName}">Category</a>
                </li>
                <li class="breadcrumb-item active" th:text="${product.name}">Product</li>
            </ol>
        </nav>
        
        <!-- Modern E-commerce Layout - 2 Column -->
        <div class="product-detail-wrapper">
            <div class="product-main-section">
                <!-- Left: Product Gallery -->
                <div class="product-gallery-wrapper">
                    <!-- Main Image -->
                    <div class="main-image-container" onclick="openImageModal()">
                        <span class="image-badge badge bg-success" th:if="${product.stockQuantity > 5}">
                            <i class="bi bi-star-fill me-1"></i>BEST SELLER
                        </span>
                        <span class="image-badge badge bg-danger" th:if="${product.stockQuantity <= 5 and product.stockQuantity > 0}">
                            <i class="bi bi-lightning-fill me-1"></i>Sắp hết
                        </span>
                        <img th:src="${productImages != null and !productImages.empty ? productImages[0].imageUrl : product.imageUrl}" 
                             class="main-image" 
                             th:alt="${product.name}" 
                             id="mainProductImage">
                    </div>
                    
                    <!-- Thumbnail Gallery - Horizontal Bottom -->
                    <div class="thumbnail-gallery-horizontal">
                        <img th:each="image : ${productImages}" 
                             th:src="${image.imageUrl}" 
                             class="thumbnail-horizontal" 
                             th:alt="${image.altText != null ? image.altText : product.name}"
                             th:classappend="${imageStat.index == 0 ? 'active' : ''}"
                             onclick="changeMainImage(this)">
                        <!-- Fallback if no images -->
                        <img th:if="${productImages == null or productImages.empty}" 
                             th:src="${product.imageUrl}" 
                             class="thumbnail-horizontal active" 
                             th:alt="${product.name}"
                             onclick="changeMainImage(this)">
                    </div>
                </div>
                
                <!-- Image Modal -->
                <div id="imageModal" class="image-modal" onclick="closeImageModal()">
                    <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
                    <span class="image-modal-nav image-modal-prev" onclick="event.stopPropagation(); prevImage()">&#10094;</span>
                    <img class="image-modal-content" id="modalImage" onclick="event.stopPropagation()">
                    <span class="image-modal-nav image-modal-next" onclick="event.stopPropagation(); nextImage()">&#10095;</span>
                </div>
                
                <!-- Right: Product Info -->
                <div class="product-info-section">
                    <h1 class="product-title" th:text="${product.name}">Product Name</h1>
                    
                    <div class="product-rating">
                        <div class="stars">
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-half"></i>
                        </div>
                        <span class="rating-count">(4.5/5 - 128 Reviews)</span>
                        <span class="stock-badge" th:if="${product.stockQuantity > 0}">Còn hàng</span>
                    </div>
                    
                    <div class="price-section">
                        <span class="current-price" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + '₫'">0₫</span>
                        <span class="original-price" th:if="${product.stockQuantity <= 10}">
                            <del th:text="${#numbers.formatDecimal(product.price * 1.2, 0, 'COMMA', 0, 'POINT')} + '₫'">0₫</del>
                        </span>
                        <span class="discount-badge" th:if="${product.stockQuantity <= 10}">-17%</span>
                    </div>
                    
                    <div class="product-short-description" th:if="${product.shortDescription != null and !product.shortDescription.isEmpty()}">
                        <p th:text="${product.shortDescription}">Mô tả ngắn về sản phẩm...</p>
                    </div>
                    
                    <div class="quantity-selector" th:if="${product.stockQuantity > 0}">
                        <label class="fw-semibold">Số lượng:</label>
                        <div class="quantity-input-group">
                            <button type="button" class="quantity-btn" id="decreaseQty">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" class="quantity-input" id="quantity" value="1" min="1" th:max="${product.stockQuantity}">
                            <button type="button" class="quantity-btn" id="increaseQty">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="action-buttons-modern" th:if="${product.stockQuantity > 0}">
                        <button class="btn-add-cart-modern" th:data-product-id="${product.id}">
                            <i class="bi bi-cart-plus me-2"></i>Thêm Vào Giỏ
                        </button>
                        <button class="btn-wishlist-modern">
                            <i class="bi bi-heart"></i>
                        </button>
                    </div>
                    
                    <!-- Shipping Info -->
                    <div class="shipping-info-section">
                        <div class="shipping-header">
                            <img th:src="@{/images/ship-icon.webp}" alt="NowFree" class="shipping-logo" 
                                 onerror="this.src='https://via.placeholder.com/80x30?text=NowFree'">
                            <span class="shipping-title">Giao Nhanh Miễn Phí 5H</span>
                        </div>
                        <div class="shipping-description">
                            <p>Bạn muốn nhận hàng trước <span class="highlight-time">10h</span> ngày mai. Đặt hàng trước <span class="highlight-time">24h</span> và chọn giao nhanh <span class="highlight-time">5H</span> ở bước thanh toán. <a href="#" class="shipping-link">Xem thêm</a></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar - Services -->
            <div class="product-sidebar">
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <i class="bi bi-truck"></i>
                        <span>MIỄN PHÍ VẬN CHUYỂN</span>
                    </div>
                    <div class="sidebar-item">
                        <img th:src="@{/images/service-1.webp}" alt="Service" class="sidebar-icon"
                             onerror="this.src='https://via.placeholder.com/50'">
                        <div>
                            <strong>Giao Nhanh Miễn Phí 5H</strong>
                            <small>Tặng ngay 100K nếu giao trễ</small>
                        </div>
                    </div>
                    <div class="sidebar-item">
                        <img th:src="@{/images/service-2.webp}" alt="Service" class="sidebar-icon"
                             onerror="this.src='https://via.placeholder.com/50'">
                        <div>
                            <strong> Cam kết hàng chính hãng</strong>
                            <small>DacSanViet cam kết đền bù 100% nếu phát hiện hàng giả, kém chất lượng</small>
                        </div>
                    </div>
                    <div class="sidebar-item">
                        <img th:src="@{/images/service-3.webp}" alt="Service" class="sidebar-icon"
                             onerror="this.src='https://via.placeholder.com/50'">
                        <div>
                            <strong>Giao Hàng Miễn Phí</strong>
                            <small>(Áp dụng cho đơn từ 300k trên toàn quốc, nội thành Hồ Chí Minh miễn phí Ship cho đơn từ 90k)</small>
                        </div>
                    </div>
                    <div class="sidebar-item">
                        <img th:src="@{/images/service-4.webp}" alt="Service" class="sidebar-icon"
                             onerror="this.src='https://via.placeholder.com/50'">
                        <div>
                            <strong>Đổi trả</strong>
                            <small>trong 7 ngày đối với sản phẩm có lỗi từ nhà sản xuất</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="product-tabs mt-5">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#story">
                        <i class="bi bi-book me-2"></i>Câu Chuyện
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#description">
                        <i class="bi bi-file-text me-2"></i>Mô Tả
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#specifications">
                        <i class="bi bi-list-ul me-2"></i>Thông Số
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="scrollToReviews(event)">
                        <i class="bi bi-star me-2"></i>Đánh Giá
                    </button>
                </li>
            </ul>
            
            <div class="tab-content">
                <div class="tab-pane fade show active" id="story">
                    <div class="product-story-section">
                        <div class="row align-items-center">
                            <div class="col-lg-6">
                                <!-- Story content from DB or fallback -->
                                <div th:if="${product.story != null and !product.story.isEmpty()}" 
                                     th:utext="${product.story}" 
                                     class="story-content">
                                </div>
                                <div th:if="${product.story == null or product.story.isEmpty()}">
                                    <h3 class="story-title">Gìn Giữ Hồn Quê, Lan Tỏa Giá Trị Việt</h3>
                                    <p class="story-text">
                                        Hành trình của chúng tôi bắt đầu từ những cánh đồng màu mỡ ở đồng bằng sông Cửu Long, 
                                        nơi mặt trời hôn lên từng trái cây mỗi buổi sáng. Chúng tôi làm việc trực tiếp với 
                                        những người nông dân địa phương để lựa chọn những sản phẩm đặc sản tốt nhất.
                                    </p>
                                    <p class="story-text">
                                        Bằng cách kết hợp phương pháp sấy khô truyền thống được truyền qua nhiều thế hệ với 
                                        các tiêu chuẩn vệ sinh hiện đại, chúng tôi đảm bảo rằng mỗi miếng bạn thưởng thức đều 
                                        là một kết nối với di sản Việt Nam. Khi bạn chọn Đặc Sản Việt, bạn đang hỗ trợ nông 
                                        nghiệp địa phương và giữ gìn truyền thống của chúng ta.
                                    </p>
                                    <div class="story-highlights mt-4">
                                        <div class="highlight-item">
                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                            <span>Làm việc trực tiếp với nông dân địa phương</span>
                                        </div>
                                        <div class="highlight-item">
                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                            <span>Phương pháp chế biến truyền thống kết hợp hiện đại</span>
                                        </div>
                                        <div class="highlight-item">
                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                            <span>Đảm bảo an toàn vệ sinh thực phẩm 100%</span>
                                        </div>
                                        <div class="highlight-item">
                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                            <span>Hỗ trợ phát triển nông nghiệp bền vững</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="story-image-container">
                                    <img th:src="${product.storyImageUrl != null and !product.storyImageUrl.isEmpty() ? product.storyImageUrl : 'https://images.unsplash.com/photo-1605000797499-95a51c5269ae?w=800&q=80'}" 
                                         alt="Product Story" 
                                         class="story-image">
                                    <div class="story-badge">
                                        <i class="bi bi-heart-fill"></i>
                                        <span>Made with Love</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="description">
                    <div th:if="${product.description != null and !product.description.isEmpty()}" 
                         th:utext="${product.description}" 
                         class="product-description-content">
                    </div>
                    <p th:if="${product.description == null or product.description.isEmpty()}">
                        Chưa có mô tả chi tiết cho sản phẩm này.
                    </p>
                </div>
                
                <div class="tab-pane fade" id="specifications">
                    <table class="specs-table">
                        <tr><td>Danh mục</td><td th:text="${product.categoryName != null ? product.categoryName : 'Chưa phân loại'}">Category</td></tr>
                        <tr><td>Tình trạng</td><td><span class="badge bg-success" th:if="${product.stockQuantity > 0}">Còn hàng</span></td></tr>
                        <tr><td>Số lượng</td><td th:text="${product.stockQuantity}">0</td></tr>
                        <tr><td>Xuất xứ</td><td th:text="${product.origin != null ? product.origin : 'Việt Nam'}">Việt Nam</td></tr>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Reviews Section -->
        <div class="reviews-section mt-5" id="reviewsSection" th:if="${product != null}">
            <h3 class="section-title mb-4"><i class="bi bi-star me-2"></i>Đánh Giá Sản Phẩm</h3>
            
            <div class="review-layout">
                <!-- Left: Rating Summary -->
                <div class="review-summary-box">
                    <div class="review-score-display">
                        <div class="review-score-large">4.8</div>
                        <div class="stars-large mb-2">
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-half"></i>
                        </div>
                        <div class="review-count">Based on 128 reviews</div>
                    </div>
                    
                    <div class="review-bars-compact">
                        <div class="review-bar-row">
                            <span class="bar-number">5</span>
                            <i class="bi bi-star-fill"></i>
                            <div class="bar-track">
                                <div class="bar-progress" style="width: 85%"></div>
                            </div>
                            <span class="bar-percentage">85%</span>
                        </div>
                        <div class="review-bar-row">
                            <span class="bar-number">4</span>
                            <i class="bi bi-star-fill"></i>
                            <div class="bar-track">
                                <div class="bar-progress" style="width: 10%"></div>
                            </div>
                            <span class="bar-percentage">10%</span>
                        </div>
                        <div class="review-bar-row">
                            <span class="bar-number">3</span>
                            <i class="bi bi-star-fill"></i>
                            <div class="bar-track">
                                <div class="bar-progress" style="width: 3%"></div>
                            </div>
                            <span class="bar-percentage">3%</span>
                        </div>
                        <div class="review-bar-row">
                            <span class="bar-number">2</span>
                            <i class="bi bi-star-fill"></i>
                            <div class="bar-track">
                                <div class="bar-progress" style="width: 1%"></div>
                            </div>
                            <span class="bar-percentage">1%</span>
                        </div>
                        <div class="review-bar-row">
                            <span class="bar-number">1</span>
                            <i class="bi bi-star-fill"></i>
                            <div class="bar-track">
                                <div class="bar-progress" style="width: 1%"></div>
                            </div>
                            <span class="bar-percentage">1%</span>
                        </div>
                    </div>
                    
                    <button class="btn-write-review">
                        <i class="bi bi-pencil-square me-2"></i>Write a Review
                    </button>
                </div>
                
                <!-- Right: Write Review Form & Reviews List -->
                <div class="review-content-box">
                    <!-- Write Review Form -->
                    <div class="write-review-form">
                        <h5 class="form-title">Share your experience</h5>
                        <form id="reviewForm" enctype="multipart/form-data">
                            <input type="hidden" id="reviewProductId" th:value="${product.id}">
                            <input type="hidden" id="reviewRating" value="5">
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="reviewerName" placeholder="Your Name *" required>
                                </div>
                                <div class="col-md-6">
                                    <input type="email" class="form-control" id="reviewerEmail" placeholder="Your Email *" required>
                                </div>
                            </div>
                            
                            <div class="form-group mb-3">
                                <input type="text" class="form-control" id="reviewTitle" placeholder="Review Title">
                                <div class="star-rating-input" id="starRatingInput">
                                    <i class="bi bi-star-fill" data-rating="1"></i>
                                    <i class="bi bi-star-fill" data-rating="2"></i>
                                    <i class="bi bi-star-fill" data-rating="3"></i>
                                    <i class="bi bi-star-fill" data-rating="4"></i>
                                    <i class="bi bi-star-fill" data-rating="5"></i>
                                    <span class="rating-hint">(Click to rate)</span>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <textarea class="form-control" id="reviewContent" rows="4" placeholder="How was the taste? Was the shipping fast?" required></textarea>
                            </div>
                            <div class="form-actions">
                                <div>
                                    <input type="file" id="reviewImages" name="images" multiple accept="image/*" style="display: none;">
                                    <button type="button" class="btn-add-photos" onclick="document.getElementById('reviewImages').click()">
                                        <i class="bi bi-camera me-2"></i>Add Photos
                                    </button>
                                    <span id="imageCount" class="ms-2 text-muted"></span>
                                </div>
                                <button type="submit" class="btn-submit-review">Submit Review</button>
                            </div>
                        </form>
                    </div>
            
                    <!-- Reviews List -->
                    <div class="reviews-list-modern"></div>
                        <div class="review-item-modern">
                            <div class="reviewer-header">
                                <div class="reviewer-avatar-circle">L</div>
                                <div class="reviewer-info">
                                    <div class="reviewer-name">Lan Nguyen</div>
                                    <div class="reviewer-badge">
                                        <i class="bi bi-patch-check-fill"></i> Verified Buyer
                                    </div>
                                </div>
                                <div class="review-time">2 days ago</div>
                            </div>
                            <div class="review-stars-row">
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                            </div>
                            <h6 class="review-title">Authentic Flavor!</h6>
                            <p class="review-text">Delicious! Tastes just like the ones I had in my childhood hometown in Tien Giang. Very crispy and not too sweet.</p>
                            <div class="review-photos">
                                <img src="https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=80&q=80" alt="Review photo">
                                <img src="https://images.unsplash.com/photo-1606787366850-de6330128bfc?w=80&q=80" alt="Review photo">
                            </div>
                        </div>
                        
                        <div class="review-item-modern">
                            <div class="reviewer-header">
                                <div class="reviewer-avatar-circle" style="background: #17a2b8;">M</div>
                                <div class="reviewer-info">
                                    <div class="reviewer-name">Minh Tran</div>
                                    <div class="reviewer-badge-simple">Reviewer</div>
                                </div>
                                <div class="review-time">1 week ago</div>
                            </div>
                            <div class="review-stars-row">
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                            </div>
                            <p class="review-text">Beautiful packaging, making it perfect for gifts. The jackfruit quality is top-notch.</p>
                        </div>
                    </div>
                    
                    <button class="btn-load-more">
                        <i class="bi bi-chevron-down me-2"></i>Load more reviews
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Q&A Section (Real-time Discussion) -->
        <div class="qa-section mt-5" id="qaSection" th:if="${product != null}">
            <h3 class="section-title mb-4"><i class="bi bi-chat-dots me-2"></i>Hỏi Đáp Sản Phẩm</h3>
            
            <div class="qa-container">
                <!-- Question Form -->
                <div class="qa-form-card mb-4">
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="userNameInput" placeholder="Tên của bạn *" required>
                        </div>
                        <div class="col-md-6">
                            <input type="email" class="form-control" id="userEmailInput" placeholder="Email của bạn *" required>
                        </div>
                    </div>
                    <div class="d-flex align-items-start gap-3">
                        <img src="https://ui-avatars.com/api/?name=User&background=4ec2b6&color=fff" 
                             class="qa-avatar" alt="Avatar" id="userAvatar">
                        <div class="flex-grow-1">
                            <textarea class="form-control qa-input" 
                                      id="questionInput" 
                                      rows="3" 
                                      placeholder="Đặt câu hỏi về sản phẩm này..."></textarea>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Câu hỏi sẽ được hiển thị real-time cho mọi người
                                </small>
                                <button class="btn btn-primary btn-sm" onclick="sendQuestion()">
                                    <i class="bi bi-send me-1"></i>Gửi câu hỏi
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Questions List -->
                <div class="qa-list" id="qaList">
                    <!-- Questions will be loaded here -->
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-chat-square-text fs-1"></i>
                        <p class="mt-2">Chưa có câu hỏi nào. Hãy là người đầu tiên đặt câu hỏi!</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FAQ Section -->
        <div class="faq-section mt-5" th:if="${product != null}">
            <h3 class="section-title mb-4"><i class="bi bi-question-circle me-2"></i>Câu Hỏi Thường Gặp</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Sản Phẩm Của Shop Có Đảm Bảo An Toàn Vệ Sinh Thực Phẩm Không?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            100% sản phẩm đều đảm bảo an toàn vệ sinh thực phẩm, có nguồn gốc xuất xứ rõ ràng và được kiểm tra kỹ lưỡng trước khi giao hàng.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Sản Phẩm Đặc Sản Của Shop Có Nguồn Gốc Từ Đâu?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Sản phẩm được lấy trực tiếp từ các vùng đặc sản nổi tiếng khắp Việt Nam, đảm bảo chất lượng và hương vị đặc trưng của từng vùng miền.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Làm Thế Nào Để Đặt Hàng?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Bạn có thể đặt hàng trực tiếp trên website, chọn sản phẩm và thêm vào giỏ hàng, sau đó điền thông tin giao hàng và thanh toán.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Thời Gian Giao Hàng Là Bao Lâu?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Thời gian giao hàng từ 2-5 ngày tùy theo khu vực. Nội thành Hà Nội và TP.HCM: 1-2 ngày. Các tỉnh thành khác: 3-5 ngày.
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Shop Có Giao Hàng Toàn Quốc Không?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Có, chúng tôi giao hàng toàn quốc. Phí vận chuyển sẽ được tính dựa trên khoảng cách và trọng lượng đơn hàng.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Tôi Có Được Kiểm Tra Hàng Trước Khi Nhận Không?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Có, bạn được quyền kiểm tra hàng trước khi thanh toán. Nếu không hài lòng, bạn có thể từ chối nhận hàng.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Shop Chấp Nhận Những Hình Thức Thanh Toán Nào?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Chúng tôi chấp nhận thanh toán COD (tiền mặt khi nhận hàng), chuyển khoản ngân hàng, và các ví điện tử như MoMo, ZaloPay, VNPay.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Chính Sách Đổi Trả Sản Phẩm Như Thế Nào?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Chúng tôi hỗ trợ đổi trả trong vòng 7 ngày nếu sản phẩm có lỗi từ nhà sản xuất hoặc không đúng mô tả. Sản phẩm phải còn nguyên vẹn.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            function toggleFaq(button) {
                const answer = button.nextElementSibling;
                const isActive = button.classList.contains('active');
                
                // Close all other FAQs in the same column
                const column = button.closest('.col-md-6');
                column.querySelectorAll('.faq-question').forEach(q => {
                    q.classList.remove('active');
                    q.nextElementSibling.classList.remove('show');
                });
                
                // Toggle current FAQ
                if (!isActive) {
                    button.classList.add('active');
                    answer.classList.add('show');
                }
            }
            
            function scrollToReviews(event) {
                event.preventDefault();
                const reviewsSection = document.getElementById('reviewsSection');
                if (reviewsSection) {
                    reviewsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        </script>
        
        <!-- Q&A WebSocket Script -->
        <script th:if="${product != null}" th:inline="javascript">
            /*<![CDATA[*/
            let stompClient = null;
            const productId = /*[[${product.id}]]*/ 0;
            
            // Connect to WebSocket
            function connectQA() {
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                
                stompClient.connect({}, function(frame) {
                    console.log('Connected to Q&A: ' + frame);
                    
                    // Subscribe to product Q&A topic (new questions/replies)
                    stompClient.subscribe('/topic/product/' + productId + '/qa', function(message) {
                        const qa = JSON.parse(message.body);
                        displayQuestion(qa);
                    });
                    
                    // Subscribe to like updates
                    stompClient.subscribe('/topic/product/' + productId + '/qa/like', function(message) {
                        const likeUpdate = JSON.parse(message.body);
                        updateLikeCount(likeUpdate.id, likeUpdate.likesCount);
                    });
                    
                    // Load existing questions from server
                    loadExistingQuestions();
                }, function(error) {
                    console.error('WebSocket connection error:', error);
                    setTimeout(connectQA, 5000); // Retry after 5 seconds
                });
            }
            
            // Send question or reply
            function sendQuestion(parentId = null) {
                const input = parentId ? document.getElementById('replyInput_' + parentId) : document.getElementById('questionInput');
                const question = input.value.trim();
                
                if (!question) {
                    alert('Vui lòng nhập câu hỏi');
                    return;
                }
                
                // Get name and email from inputs
                const nameInput = document.getElementById('userNameInput');
                const emailInput = document.getElementById('userEmailInput');
                
                const userName = nameInput ? nameInput.value.trim() : '';
                const userEmail = emailInput ? emailInput.value.trim() : '';
                
                if (!userName || !userEmail) {
                    alert('Vui lòng nhập tên và email');
                    // Focus on first empty field
                    if (!userName && nameInput) {
                        nameInput.focus();
                    } else if (!userEmail && emailInput) {
                        emailInput.focus();
                    }
                    return;
                }
                
                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(userEmail)) {
                    alert('Email không hợp lệ');
                    if (emailInput) emailInput.focus();
                    return;
                }
                
                // Save to localStorage
                localStorage.setItem('qa_username', userName);
                localStorage.setItem('qa_email', userEmail);
                
                const qaData = {
                    productId: productId,
                    parentId: parentId,
                    userName: userName,
                    userEmail: userEmail,
                    question: question,
                    timestamp: new Date().toISOString()
                };
                
                if (stompClient && stompClient.connected) {
                    // Send to server
                    stompClient.send('/app/product/qa', {}, JSON.stringify(qaData));
                    input.value = '';
                    
                    // Hide reply form if it's a reply
                    if (parentId) {
                        const replyForm = document.getElementById('replyForm_' + parentId);
                        if (replyForm) replyForm.style.display = 'none';
                    }
                } else {
                    alert('Đang kết nối... Vui lòng thử lại');
                    connectQA();
                }
            }
            
            // Display question
            function displayQuestion(qa) {
                const qaList = document.getElementById('qaList');
                
                // Check if this question already exists (prevent duplicates)
                const existingItem = document.querySelector(`[data-qa-id="${qa.id}"]`);
                if (existingItem) {
                    console.log('Question already displayed, skipping duplicate');
                    return;
                }
                
                // Remove empty message if exists
                const emptyMsg = qaList.querySelector('.text-center');
                if (emptyMsg) {
                    emptyMsg.remove();
                }
                
                const qaItem = document.createElement('div');
                qaItem.className = qa.parentId ? 'qa-reply-item' : 'qa-item';
                qaItem.setAttribute('data-qa-id', qa.id);
                
                const likesCount = qa.likesCount || 0;
                const repliesCount = qa.repliesCount || 0;
                
                let actionsHtml = '<div class="qa-actions mt-2">';
                actionsHtml += '<button class="qa-action-btn" onclick="toggleLike(' + qa.id + ')" data-qa-like-btn="' + qa.id + '">';
                actionsHtml += '<i class="bi bi-hand-thumbs-up me-1"></i>Thích ' + (likesCount > 0 ? '(' + likesCount + ')' : '');
                actionsHtml += '</button>';
                
                if (!qa.parentId) {
                    actionsHtml += '<button class="qa-action-btn ms-2" onclick="toggleReplyForm(' + qa.id + ')">';
                    actionsHtml += '<i class="bi bi-reply me-1"></i>Trả lời ' + (repliesCount > 0 ? '(' + repliesCount + ')' : '');
                    actionsHtml += '</button>';
                }
                actionsHtml += '</div>';
                
                let replyFormHtml = '';
                if (!qa.parentId) {
                    const currentUserName = getUserName() || 'User';
                    replyFormHtml += '<div id="replyForm_' + qa.id + '" class="qa-reply-form mt-3" style="display: none;">';
                    replyFormHtml += '<div class="d-flex align-items-start gap-2">';
                    replyFormHtml += '<img src="https://ui-avatars.com/api/?name=' + encodeURIComponent(currentUserName) + '&background=4ec2b6&color=fff" class="qa-avatar-small" alt="Avatar">';
                    replyFormHtml += '<div class="flex-grow-1">';
                    replyFormHtml += '<textarea class="form-control form-control-sm" id="replyInput_' + qa.id + '" rows="2" placeholder="Viết câu trả lời..."></textarea>';
                    replyFormHtml += '<div class="mt-2">';
                    replyFormHtml += '<button class="btn btn-primary btn-sm" onclick="sendQuestion(' + qa.id + ')"><i class="bi bi-send me-1"></i>Gửi</button>';
                    replyFormHtml += '<button class="btn btn-secondary btn-sm ms-2" onclick="toggleReplyForm(' + qa.id + ')">Hủy</button>';
                    replyFormHtml += '</div></div></div></div>';
                    replyFormHtml += '<div id="replies_' + qa.id + '" class="qa-replies-container mt-3"></div>';
                }
                
                qaItem.innerHTML = 
                    '<div class="qa-item-header">' +
                        '<img src="https://ui-avatars.com/api/?name=' + encodeURIComponent(qa.userName) + '&background=4ec2b6&color=fff" class="qa-avatar" alt="' + qa.userName + '">' +
                        '<div class="qa-item-content">' +
                            '<div class="d-flex justify-content-between align-items-start">' +
                                '<div>' +
                                    '<span class="qa-item-author">' + qa.userName + '</span>' +
                                    '<span class="qa-item-time ms-2">' + formatTime(qa.timestamp) + '</span>' +
                                '</div>' +
                            '</div>' +
                            '<p class="qa-item-question mt-2">' + qa.question + '</p>' +
                            actionsHtml +
                            replyFormHtml +
                        '</div>' +
                    '</div>';
                
                // If it's a reply, add to parent's replies container
                if (qa.parentId) {
                    const repliesContainer = document.getElementById('replies_' + qa.parentId);
                    if (repliesContainer) {
                        repliesContainer.appendChild(qaItem);
                        updateReplyCount(qa.parentId);
                    }
                } else {
                    qaList.insertBefore(qaItem, qaList.firstChild);
                    if (repliesCount > 0) {
                        loadReplies(qa.id);
                    }
                }
                
                // Check if current user has liked this Q&A
                checkLikedStatus(qa.id);
            }
            
            // Check if current user has liked a Q&A
            function checkLikedStatus(qaId) {
                const userIdentifier = getUserIdentifier();
                fetch('/api/products/qa/' + qaId + '/hasLiked?userIdentifier=' + encodeURIComponent(userIdentifier))
                    .then(response => response.json())
                    .then(hasLiked => {
                        const likeBtn = document.querySelector('[data-qa-like-btn="' + qaId + '"]');
                        if (likeBtn && hasLiked) {
                            likeBtn.classList.add('liked');
                            const icon = likeBtn.querySelector('i');
                            if (icon) {
                                icon.classList.remove('bi-hand-thumbs-up');
                                icon.classList.add('bi-hand-thumbs-up-fill');
                            }
                        }
                    })
                    .catch(error => console.error('Error checking liked status:', error));
            }
            
            // Toggle reply form
            function toggleReplyForm(questionId) {
                const replyForm = document.getElementById('replyForm_' + questionId);
                if (replyForm) {
                    replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
                }
            }
            
            // Get user identifier (email if logged in, or generate session ID)
            function getUserIdentifier() {
                // Try to get email from form
                const emailInput = document.getElementById('userEmailInput');
                if (emailInput && emailInput.value.trim()) {
                    return emailInput.value.trim();
                }
                
                // Try localStorage
                const savedEmail = localStorage.getItem('qa_email');
                if (savedEmail) {
                    return savedEmail;
                }
                
                // Generate session ID if not logged in
                let sessionId = localStorage.getItem('qa_session_id');
                if (!sessionId) {
                    sessionId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('qa_session_id', sessionId);
                }
                return sessionId;
            }
            
            // Toggle like
            function toggleLike(qaId) {
                const userIdentifier = getUserIdentifier();
                
                fetch('/api/products/qa/' + qaId + '/like?userIdentifier=' + encodeURIComponent(userIdentifier))
                    .then(response => response.json())
                    .catch(error => console.error('Error toggling like:', error));
            }
            
            // Update like count in UI (called from WebSocket)
            function updateLikeCount(qaId, newLikesCount) {
                const qaItem = document.querySelector('[data-qa-id="' + qaId + '"]');
                if (qaItem) {
                    const likeBtn = qaItem.querySelector('.qa-action-btn');
                    if (likeBtn) {
                        const likesText = newLikesCount > 0 ? '(' + newLikesCount + ')' : '';
                        
                        // Check if current user has liked
                        const userIdentifier = getUserIdentifier();
                        fetch('/api/products/qa/' + qaId + '/hasLiked?userIdentifier=' + encodeURIComponent(userIdentifier))
                            .then(response => response.json())
                            .then(hasLiked => {
                                const iconClass = hasLiked ? 'bi-hand-thumbs-up-fill' : 'bi-hand-thumbs-up';
                                const btnClass = hasLiked ? 'qa-action-btn liked' : 'qa-action-btn';
                                likeBtn.className = btnClass;
                                likeBtn.innerHTML = '<i class="bi ' + iconClass + ' me-1"></i>Thích ' + likesText;
                            });
                    }
                }
            }
            
            // Load replies for a question
            function loadReplies(questionId) {
                fetch('/api/products/qa/' + questionId + '/replies')
                    .then(response => response.json())
                    .then(replies => {
                        replies.forEach(reply => displayQuestion(reply));
                    })
                    .catch(error => console.error('Error loading replies:', error));
            }
            
            // Update reply count
            function updateReplyCount(questionId) {
                const repliesContainer = document.getElementById('replies_' + questionId);
                if (repliesContainer) {
                    const count = repliesContainer.querySelectorAll('.qa-reply-item').length;
                    const qaItem = document.querySelector('[data-qa-id="' + questionId + '"]');
                    if (qaItem) {
                        const replyBtns = qaItem.querySelectorAll('.qa-action-btn');
                        // Reply button is the second one (after Like button)
                        if (replyBtns.length > 1) {
                            const replyBtn = replyBtns[1];
                            const repliesText = count > 0 ? '(' + count + ')' : '';
                            replyBtn.innerHTML = '<i class="bi bi-reply me-1"></i>Trả lời ' + repliesText;
                        }
                    }
                }
            }
            
            // Load existing questions
            function loadExistingQuestions() {
                // Fetch existing Q&A from backend
                fetch('/api/products/' + productId + '/qa')
                    .then(response => response.json())
                    .then(questions => {
                        questions.forEach(qa => displayQuestion(qa));
                    })
                    .catch(error => {
                        console.error('Error loading Q&A:', error);
                    });
            }
            
            // Get user name
            function getUserName() {
                const nameInput = document.getElementById('userNameInput');
                if (nameInput && nameInput.value.trim()) {
                    localStorage.setItem('qa_username', nameInput.value.trim());
                    return nameInput.value.trim();
                }
                
                // Try localStorage
                const savedName = localStorage.getItem('qa_username');
                if (savedName && nameInput) {
                    nameInput.value = savedName;
                }
                return savedName || '';
            }
            
            // Get user email
            function getUserEmail() {
                const emailInput = document.getElementById('userEmailInput');
                if (emailInput && emailInput.value.trim()) {
                    localStorage.setItem('qa_email', emailInput.value.trim());
                    return emailInput.value.trim();
                }
                
                // Try localStorage
                const savedEmail = localStorage.getItem('qa_email');
                if (savedEmail && emailInput) {
                    emailInput.value = savedEmail;
                }
                return savedEmail || '';
            }
            
            // Update avatar when name changes
            document.addEventListener('DOMContentLoaded', function() {
                const nameInput = document.getElementById('userNameInput');
                const emailInput = document.getElementById('userEmailInput');
                const avatar = document.getElementById('userAvatar');
                
                // Load saved values
                const savedName = localStorage.getItem('qa_username');
                const savedEmail = localStorage.getItem('qa_email');
                if (savedName) nameInput.value = savedName;
                if (savedEmail) emailInput.value = savedEmail;
                
                // Update avatar on name change
                if (nameInput) {
                    nameInput.addEventListener('input', function() {
                        if (this.value.trim()) {
                            avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(this.value)}&background=4ec2b6&color=fff`;
                        }
                    });
                }
            });
            
            // Format time
            function formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = Math.floor((now - date) / 1000); // seconds
                
                if (diff < 60) return 'Vừa xong';
                if (diff < 3600) return Math.floor(diff / 60) + ' phút trước';
                if (diff < 86400) return Math.floor(diff / 3600) + ' giờ trước';
                return Math.floor(diff / 86400) + ' ngày trước';
            }
            
            // Enter key to send
            document.getElementById('questionInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendQuestion();
                }
            });
            
            // Connect on page load
            document.addEventListener('DOMContentLoaded', function() {
                connectQA();
            });
            
            // Disconnect on page unload
            window.addEventListener('beforeunload', function() {
                if (stompClient) {
                    stompClient.disconnect();
                }
            });
            /*]]>*/
        </script>
        
        <!-- SockJS and STOMP libraries -->
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
        
        <!-- Related Products Section -->
        <div class="related-products mt-5" th:if="${product != null and relatedProducts != null and !relatedProducts.empty}">
            <h3 class="section-title mb-4"><i class="bi bi-grid me-2"></i>Có Thể Bạn Thích</h3>
            <div class="related-products-slider-wrapper">
                <div class="related-products-slider" id="relatedProductsSlider">
                    <div class="related-product-item" th:each="relatedProduct : ${relatedProducts}">
                        <div class="product-card h-100">
                            <div class="position-relative">
                                <img th:src="${relatedProduct.imageUrl}" 
                                     class="product-img w-100" 
                                     th:alt="${relatedProduct.name}"
                                     onerror="this.src='https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&q=80'">
                                <span class="badge bg-success position-absolute top-0 end-0 m-2" th:if="${relatedProduct.isFeatured}">
                                    <i class="bi bi-star-fill me-1"></i>Nổi bật
                                </span>
                                <span class="badge bg-danger position-absolute top-0 end-0 m-2" th:if="${relatedProduct.stockQuantity <= 5 and relatedProduct.stockQuantity > 0}">
                                    <i class="bi bi-fire me-1"></i>Sắp hết
                                </span>
                            </div>
                            <div class="p-3">
                                <a th:href="@{/products/{id}(id=${relatedProduct.id})}" class="text-decoration-none text-dark">
                                    <h6 class="fw-bold mb-2" th:text="${relatedProduct.name}">Tên sản phẩm</h6>
                                </a>
                                <p class="text-muted small mb-2" style="height: 40px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;" 
                                   th:text="${relatedProduct.description}">Mô tả</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-primary fw-bold" th:text="${#numbers.formatDecimal(relatedProduct.price, 0, 'COMMA', 0, 'POINT')} + '₫'">0₫</span>
                                    <button class="btn btn-sm btn-primary add-to-cart-btn" 
                                            th:data-product-id="${relatedProduct.id}"
                                            th:data-product-name="${relatedProduct.name}"
                                            th:data-product-price="${relatedProduct.price}"
                                            th:data-product-image="${relatedProduct.imageUrl}"
                                            onclick="addToCartFromRelated(this)">
                                        <i class="bi bi-cart-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            // Related Products Auto Slider
            document.addEventListener('DOMContentLoaded', function() {
                const slider = document.getElementById('relatedProductsSlider');
                if (!slider) return;
                
                const items = slider.querySelectorAll('.related-product-item');
                if (items.length <= 4) return; // No need to slide if 4 or fewer items
                
                // Clone items for infinite loop
                items.forEach(item => {
                    const clone = item.cloneNode(true);
                    slider.appendChild(clone);
                });
                
                let scrollPosition = 0;
                let isHovered = false;
                let animationId = null;
                
                function autoSlide() {
                    if (!isHovered) {
                        scrollPosition += 0.5; // Scroll speed
                        
                        // Reset position for infinite loop
                        const itemWidth = items[0].offsetWidth + 16; // width + gap
                        const totalWidth = itemWidth * items.length;
                        
                        if (scrollPosition >= totalWidth) {
                            scrollPosition = 0;
                        }
                        
                        slider.style.transform = `translateX(-${scrollPosition}px)`;
                    }
                    
                    animationId = requestAnimationFrame(autoSlide);
                }
                
                // Start auto slide
                autoSlide();
                
                // Pause on hover
                slider.addEventListener('mouseenter', function() {
                    isHovered = true;
                });
                
                // Resume on mouse leave
                slider.addEventListener('mouseleave', function() {
                    isHovered = false;
                });
                
                // Clean up on page unload
                window.addEventListener('beforeunload', function() {
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                    }
                });
            });
            
            // Image gallery management
            let currentImageIndex = 0;
            let imageUrls = [];
            
            // Initialize image URLs
            document.addEventListener('DOMContentLoaded', function() {
                const thumbnails = document.querySelectorAll('.thumbnail-horizontal');
                imageUrls = Array.from(thumbnails).map(thumb => thumb.src);
                
                // Auto slide images
                if (thumbnails.length > 1) {
                    setInterval(function() {
                        currentImageIndex = (currentImageIndex + 1) % thumbnails.length;
                        changeMainImage(thumbnails[currentImageIndex]);
                    }, 3000); // Change image every 3 seconds
                }
            });
            
            // Change main image when clicking thumbnail
            function changeMainImage(thumbnail) {
                const mainImage = document.getElementById('mainProductImage');
                if (mainImage && thumbnail) {
                    mainImage.src = thumbnail.src;
                    
                    // Update active state
                    document.querySelectorAll('.thumbnail-horizontal').forEach(t => {
                        t.classList.remove('active');
                    });
                    thumbnail.classList.add('active');
                    
                    // Update current index
                    const thumbnails = document.querySelectorAll('.thumbnail-horizontal');
                    currentImageIndex = Array.from(thumbnails).indexOf(thumbnail);
                }
            }
            
            // Open image modal
            function openImageModal() {
                const modal = document.getElementById('imageModal');
                const modalImg = document.getElementById('modalImage');
                const mainImage = document.getElementById('mainProductImage');
                
                if (modal && modalImg && mainImage) {
                    modal.classList.add('show');
                    modalImg.src = mainImage.src;
                    document.body.style.overflow = 'hidden'; // Prevent scrolling
                }
            }
            
            // Close image modal
            function closeImageModal() {
                const modal = document.getElementById('imageModal');
                if (modal) {
                    modal.classList.remove('show');
                    document.body.style.overflow = ''; // Restore scrolling
                }
            }
            
            // Previous image in modal
            function prevImage() {
                if (imageUrls.length > 0) {
                    currentImageIndex = (currentImageIndex - 1 + imageUrls.length) % imageUrls.length;
                    const modalImg = document.getElementById('modalImage');
                    if (modalImg) {
                        modalImg.src = imageUrls[currentImageIndex];
                    }
                }
            }
            
            // Next image in modal
            function nextImage() {
                if (imageUrls.length > 0) {
                    currentImageIndex = (currentImageIndex + 1) % imageUrls.length;
                    const modalImg = document.getElementById('modalImage');
                    if (modalImg) {
                        modalImg.src = imageUrls[currentImageIndex];
                    }
                }
            }
            
            // Keyboard navigation
            document.addEventListener('keydown', function(e) {
                const modal = document.getElementById('imageModal');
                if (modal && modal.classList.contains('show')) {
                    if (e.key === 'Escape') {
                        closeImageModal();
                    } else if (e.key === 'ArrowLeft') {
                        prevImage();
                    } else if (e.key === 'ArrowRight') {
                        nextImage();
                    }
                }
            });
            
            // Review Form Handling
            document.addEventListener('DOMContentLoaded', function() {
                // Star rating input
                const starInputs = document.querySelectorAll('#starRatingInput i');
                starInputs.forEach(star => {
                    star.addEventListener('click', function() {
                        const rating = parseInt(this.getAttribute('data-rating'));
                        document.getElementById('reviewRating').value = rating;
                        
                        // Update star display
                        starInputs.forEach((s, index) => {
                            if (index < rating) {
                                s.classList.remove('bi-star');
                                s.classList.add('bi-star-fill');
                            } else {
                                s.classList.remove('bi-star-fill');
                                s.classList.add('bi-star');
                            }
                        });
                    });
                });
                
                // Image file input change
                document.getElementById('reviewImages').addEventListener('change', function() {
                    const count = this.files.length;
                    document.getElementById('imageCount').textContent = count > 0 ? `${count} photo(s) selected` : '';
                });
                
                // Form submit
                document.getElementById('reviewForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData();
                    formData.append('productId', document.getElementById('reviewProductId').value);
                    formData.append('reviewerName', document.getElementById('reviewerName').value);
                    formData.append('reviewerEmail', document.getElementById('reviewerEmail').value);
                    formData.append('rating', document.getElementById('reviewRating').value);
                    formData.append('title', document.getElementById('reviewTitle').value);
                    formData.append('content', document.getElementById('reviewContent').value);
                    
                    // Add images
                    const images = document.getElementById('reviewImages').files;
                    for (let i = 0; i < images.length; i++) {
                        formData.append('images', images[i]);
                    }
                    
                    // Submit
                    fetch('/api/reviews/create', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert('Review submitted successfully!');
                        location.reload(); // Reload to show new review
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to submit review. Please try again.');
                    });
                });
            });
            
            // Add to cart from related products
            function addToCartFromRelated(button) {
                const productId = button.getAttribute('data-product-id');
                const productName = button.getAttribute('data-product-name');
                const productPrice = parseFloat(button.getAttribute('data-product-price'));
                const productImage = button.getAttribute('data-product-image');
                
                // Add to cart using cart manager
                if (typeof addToCart === 'function') {
                    const product = {
                        id: productId,
                        name: productName,
                        price: productPrice,
                        imageUrl: productImage,
                        quantity: 1
                    };
                    
                    // Add to localStorage cart
                    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
                    const existingItem = cart.find(item => item.id == productId);
                    
                    if (existingItem) {
                        existingItem.quantity += 1;
                    } else {
                        cart.push(product);
                    }
                    
                    localStorage.setItem('cart', JSON.stringify(cart));
                    
                    // Update cart badge
                    if (typeof updateCartBadge === 'function') {
                        updateCartBadge();
                    }
                    
                    // Show success feedback
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<i class="bi bi-check-lg"></i>';
                    button.classList.add('btn-success');
                    button.classList.remove('btn-primary');
                    button.disabled = true;
                    
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.classList.remove('btn-success');
                        button.classList.add('btn-primary');
                        button.disabled = false;
                    }, 1500);
                }
            }
        </script>
    </div>
    
    <div class="container py-5" th:if="${product == null}">
        <div class="text-center">
            <i class="bi bi-exclamation-triangle display-1 text-muted"></i>
            <h2 class="mt-3">Không Tìm Thấy Sản Phẩm</h2>
            <a th:href="@{/products}" class="btn btn-primary mt-3"><i class="bi bi-arrow-left me-2"></i>Quay Lại</a>
        </div>
    </div>
    
    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/cart-manager.js(v=1)}"></script>
    <script th:src="@{/js/cart-sync.js(v=1)}"></script>
    <script th:src="@{/js/cart-animations-v2.js(v=1)}"></script>
    <script th:src="@{/js/ecommerce-enhanced.js(v=1)}"></script>
    <script th:src="@{/js/product-detail.js(v=1)}"></script>
    <script th:src="@{/js/header.js(v=1)}"></script>
</body>
</html>
