<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product != null ? product.name + ' - Đặc Sản Việt' : 'Chi Tiết Sản Phẩm'}">Chi Tiết Sản Phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/header.css(v=1)}">
    <link rel="stylesheet" th:href="@{/css/modern-ecommerce.css(v=1)}">
    <link rel="stylesheet" th:href="@{/css/product-detail.css(v=1)}">
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>
    <div th:replace="~{fragments/header :: mobile-menu}"></div>
    
    <div class="container py-5" th:if="${product != null}">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/}" class="text-teal"><i class="bi bi-house me-1"></i>Trang Chủ</a></li>
                <li class="breadcrumb-item"><a th:href="@{/products}" class="text-teal">Sản Phẩm</a></li>
                <li class="breadcrumb-item" th:if="${product.category != null}">
                    <a th:href="@{/products(categoryId=${product.categoryId})}" class="text-teal" th:text="${product.categoryName}">Category</a>
                </li>
                <li class="breadcrumb-item active" th:text="${product.name}">Product</li>
            </ol>
        </nav>
        
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="product-gallery">
                    <div class="main-image-container">
                        <span class="image-badge badge bg-danger" th:if="${product.stockQuantity <= 5 and product.stockQuantity > 0}">
                            <i class="bi bi-lightning-fill me-1"></i>Sắp hết
                        </span>
                        <img th:src="${productImages != null and !productImages.empty ? productImages[0].imageUrl : product.imageUrl}" 
                             class="main-image" 
                             th:alt="${product.name}" 
                             id="mainProductImage">
                    </div>
                    <div class="thumbnail-gallery">
                        <img th:each="image : ${productImages}" 
                             th:src="${image.imageUrl}" 
                             class="thumbnail" 
                             th:alt="${image.altText != null ? image.altText : product.name}"
                             th:classappend="${imageStat.index == 0 ? 'active' : ''}">
                        <!-- Fallback if no images -->
                        <img th:if="${productImages == null or productImages.empty}" 
                             th:src="${product.imageUrl}" 
                             class="thumbnail active" 
                             th:alt="${product.name}">
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="product-info-card">
                    <h1 class="product-title" th:text="${product.name}">Product Name</h1>
                    
                    <div class="product-rating">
                        <div class="stars">
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-half"></i>
                        </div>
                        <span class="rating-count">(4.5/5 - 128 đánh giá)</span>
                    </div>
                    
                    <div class="price-section">
                        <div class="d-flex align-items-center gap-3 flex-wrap">
                            <span class="current-price" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + '₫'">0₫</span>
                            <span class="discount-badge" th:if="${product.stockQuantity <= 10}">-15%</span>
                        </div>
                    </div>
                    
                    <div th:if="${product.stockQuantity > 0}" th:classappend="${product.stockQuantity <= 5 ? 'stock-status low-stock' : 'stock-status in-stock'}">
                        <i class="bi bi-check-circle-fill"></i>
                        <span>Còn <strong th:text="${product.stockQuantity}">0</strong> sản phẩm</span>
                    </div>
                    <div th:if="${product.stockQuantity == 0}" class="stock-status out-of-stock">
                        <i class="bi bi-x-circle-fill"></i>
                        <span>Hết hàng</span>
                    </div>
                    
                    <div class="quantity-selector" th:if="${product.stockQuantity > 0}">
                        <label class="fw-semibold">Số lượng:</label>
                        <div class="quantity-input-group">
                            <button type="button" class="quantity-btn" id="decreaseQty">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" class="quantity-input" id="quantity" value="1" min="1" th:max="${product.stockQuantity}">
                            <button type="button" class="quantity-btn" id="increaseQty">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="action-buttons" th:if="${product.stockQuantity > 0}">
                        <button class="btn-add-cart btn-primary-gradient" th:data-product-id="${product.id}">
                            <i class="bi bi-cart-plus me-2"></i>Thêm Vào Giỏ
                        </button>
                        <a th:href="@{/checkout}" class="btn-buy-now btn-secondary-gradient">
                            <i class="bi bi-lightning-fill me-2"></i>Mua Ngay
                        </a>
                        <button class="btn-wishlist">
                            <i class="bi bi-heart"></i>
                        </button>
                    </div>
                    
                    <div class="product-features">
                        <div class="feature-item">
                            <div class="feature-icon success"><i class="bi bi-shield-check"></i></div>
                            <div><strong>Chính hãng</strong><br><small>100% đảm bảo</small></div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon primary"><i class="bi bi-truck"></i></div>
                            <div><strong>Miễn phí ship</strong><br><small>Đơn từ 300k</small></div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon warning"><i class="bi bi-arrow-repeat"></i></div>
                            <div><strong>Đổi trả 7 ngày</strong><br><small>Miễn phí 100%</small></div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon info"><i class="bi bi-headset"></i></div>
                            <div><strong>Hỗ trợ 24/7</strong><br><small>Tư vấn nhiệt tình</small></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="product-tabs mt-5">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#description">
                        <i class="bi bi-file-text me-2"></i>Mô Tả
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#specifications">
                        <i class="bi bi-list-ul me-2"></i>Thông Số
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="scrollToReviews(event)">
                        <i class="bi bi-star me-2"></i>Đánh Giá
                    </button>
                </li>
            </ul>
            
            <div class="tab-content">
                <div class="tab-pane fade show active" id="description">
                    <p th:text="${product.description}">Mô tả sản phẩm...</p>
                </div>
                
                <div class="tab-pane fade" id="specifications">
                    <table class="specs-table">
                        <tr><td>Danh mục</td><td th:text="${product.categoryName != null ? product.categoryName : 'Chưa phân loại'}">Category</td></tr>
                        <tr><td>Tình trạng</td><td><span class="badge bg-success" th:if="${product.stockQuantity > 0}">Còn hàng</span></td></tr>
                        <tr><td>Số lượng</td><td th:text="${product.stockQuantity}">0</td></tr>
                        <tr><td>Xuất xứ</td><td th:text="${product.origin != null ? product.origin : 'Việt Nam'}">Việt Nam</td></tr>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Reviews Section -->
        <div class="reviews-section mt-5" id="reviewsSection" th:if="${product != null}">
            <h3 class="section-title mb-4"><i class="bi bi-star me-2"></i>Đánh Giá Sản Phẩm</h3>
            
            <div class="review-summary-card">
                <div class="row">
                    <div class="col-md-4 text-center border-end">
                        <div class="review-score-large">4.5</div>
                        <div class="stars mb-2">
                            <i class="bi bi-star-fill text-warning"></i>
                            <i class="bi bi-star-fill text-warning"></i>
                            <i class="bi bi-star-fill text-warning"></i>
                            <i class="bi bi-star-fill text-warning"></i>
                            <i class="bi bi-star-half text-warning"></i>
                        </div>
                        <div class="text-muted">128 đánh giá</div>
                    </div>
                    <div class="col-md-8">
                        <div class="review-bars-list">
                            <div class="review-bar-item">
                                <span class="bar-label">5 <i class="bi bi-star-fill text-warning"></i></span>
                                <div class="bar-container">
                                    <div class="bar-fill" style="width: 70%"></div>
                                </div>
                                <span class="bar-percent">70%</span>
                            </div>
                            <div class="review-bar-item">
                                <span class="bar-label">4 <i class="bi bi-star-fill text-warning"></i></span>
                                <div class="bar-container">
                                    <div class="bar-fill" style="width: 20%"></div>
                                </div>
                                <span class="bar-percent">20%</span>
                            </div>
                            <div class="review-bar-item">
                                <span class="bar-label">3 <i class="bi bi-star-fill text-warning"></i></span>
                                <div class="bar-container">
                                    <div class="bar-fill" style="width: 7%"></div>
                                </div>
                                <span class="bar-percent">7%</span>
                            </div>
                            <div class="review-bar-item">
                                <span class="bar-label">2 <i class="bi bi-star-fill text-warning"></i></span>
                                <div class="bar-container">
                                    <div class="bar-fill" style="width: 2%"></div>
                                </div>
                                <span class="bar-percent">2%</span>
                            </div>
                            <div class="review-bar-item">
                                <span class="bar-label">1 <i class="bi bi-star-fill text-warning"></i></span>
                                <div class="bar-container">
                                    <div class="bar-fill" style="width: 1%"></div>
                                </div>
                                <span class="bar-percent">1%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Review Items -->
            <div class="reviews-list mt-4">
                <div class="review-item-card">
                    <div class="d-flex align-items-start">
                        <img src="https://ui-avatars.com/api/?name=Nguyen+Van+A&background=4ec2b6&color=fff" 
                             class="reviewer-avatar-img me-3" alt="Avatar">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <div class="fw-bold">Nguyễn Văn A</div>
                                    <div class="stars-small">
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                    </div>
                                </div>
                                <small class="text-muted">2 ngày trước</small>
                            </div>
                            <p class="mb-2">Sản phẩm rất tốt, chất lượng đúng như mô tả. Giao hàng nhanh, đóng gói cẩn thận. Sẽ ủng hộ shop lần sau!</p>
                            <div class="review-images">
                                <img src="https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=100&q=80" 
                                     class="review-img" alt="Review">
                                <img src="https://images.unsplash.com/photo-1606787366850-de6330128bfc?w=100&q=80" 
                                     class="review-img" alt="Review">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="review-item-card">
                    <div class="d-flex align-items-start">
                        <img src="https://ui-avatars.com/api/?name=Tran+Thi+B&background=D2691E&color=fff" 
                             class="reviewer-avatar-img me-3" alt="Avatar">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <div class="fw-bold">Trần Thị B</div>
                                    <div class="stars-small">
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star-fill text-warning"></i>
                                        <i class="bi bi-star text-warning"></i>
                                    </div>
                                </div>
                                <small class="text-muted">5 ngày trước</small>
                            </div>
                            <p class="mb-0">Chất lượng tốt, giá cả hợp lý. Đóng gói cẩn thận. Sẽ mua lại!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FAQ Section -->
        <div class="faq-section mt-5" th:if="${product != null}">
            <h3 class="section-title mb-4"><i class="bi bi-question-circle me-2"></i>Câu Hỏi Thường Gặp</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Sản Phẩm Của Shop Có Đảm Bảo An Toàn Vệ Sinh Thực Phẩm Không?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            100% sản phẩm đều đảm bảo an toàn vệ sinh thực phẩm, có nguồn gốc xuất xứ rõ ràng và được kiểm tra kỹ lưỡng trước khi giao hàng.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Sản Phẩm Đặc Sản Của Shop Có Nguồn Gốc Từ Đâu?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Sản phẩm được lấy trực tiếp từ các vùng đặc sản nổi tiếng khắp Việt Nam, đảm bảo chất lượng và hương vị đặc trưng của từng vùng miền.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Làm Thế Nào Để Đặt Hàng?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Bạn có thể đặt hàng trực tiếp trên website, chọn sản phẩm và thêm vào giỏ hàng, sau đó điền thông tin giao hàng và thanh toán.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Thời Gian Giao Hàng Là Bao Lâu?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Thời gian giao hàng từ 2-5 ngày tùy theo khu vực. Nội thành Hà Nội và TP.HCM: 1-2 ngày. Các tỉnh thành khác: 3-5 ngày.
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Shop Có Giao Hàng Toàn Quốc Không?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Có, chúng tôi giao hàng toàn quốc. Phí vận chuyển sẽ được tính dựa trên khoảng cách và trọng lượng đơn hàng.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Tôi Có Được Kiểm Tra Hàng Trước Khi Nhận Không?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Có, bạn được quyền kiểm tra hàng trước khi thanh toán. Nếu không hài lòng, bạn có thể từ chối nhận hàng.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Shop Chấp Nhận Những Hình Thức Thanh Toán Nào?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Chúng tôi chấp nhận thanh toán COD (tiền mặt khi nhận hàng), chuyển khoản ngân hàng, và các ví điện tử như MoMo, ZaloPay, VNPay.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Chính Sách Đổi Trả Sản Phẩm Như Thế Nào?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Chúng tôi hỗ trợ đổi trả trong vòng 7 ngày nếu sản phẩm có lỗi từ nhà sản xuất hoặc không đúng mô tả. Sản phẩm phải còn nguyên vẹn.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            function toggleFaq(button) {
                const answer = button.nextElementSibling;
                const isActive = button.classList.contains('active');
                
                // Close all other FAQs in the same column
                const column = button.closest('.col-md-6');
                column.querySelectorAll('.faq-question').forEach(q => {
                    q.classList.remove('active');
                    q.nextElementSibling.classList.remove('show');
                });
                
                // Toggle current FAQ
                if (!isActive) {
                    button.classList.add('active');
                    answer.classList.add('show');
                }
            }
            
            function scrollToReviews(event) {
                event.preventDefault();
                const reviewsSection = document.getElementById('reviewsSection');
                if (reviewsSection) {
                    reviewsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        </script>
        
        <!-- Related Products Section -->
        <div class="related-products mt-5" th:if="${product != null and relatedProducts != null and !relatedProducts.empty}">
            <h3 class="section-title mb-4"><i class="bi bi-grid me-2"></i>Có Thể Bạn Thích</h3>
            <div class="row g-4">
                <div class="col-lg-3 col-md-4 col-sm-6" th:each="relatedProduct : ${relatedProducts}">
                    <div class="product-card h-100">
                        <div class="position-relative">
                            <img th:src="${relatedProduct.imageUrl}" 
                                 class="product-img w-100" 
                                 th:alt="${relatedProduct.name}"
                                 onerror="this.src='https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&q=80'">
                            <span class="badge bg-success position-absolute top-0 end-0 m-2" th:if="${relatedProduct.isFeatured}">
                                <i class="bi bi-star-fill me-1"></i>Nổi bật
                            </span>
                            <span class="badge bg-danger position-absolute top-0 end-0 m-2" th:if="${relatedProduct.stockQuantity <= 5 and relatedProduct.stockQuantity > 0}">
                                <i class="bi bi-fire me-1"></i>Sắp hết
                            </span>
                        </div>
                        <div class="p-3">
                            <h6 class="fw-bold mb-2" th:text="${relatedProduct.name}">Tên sản phẩm</h6>
                            <p class="text-muted small mb-2" style="height: 40px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;" 
                               th:text="${relatedProduct.description}">Mô tả</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-primary fw-bold" th:text="${#numbers.formatDecimal(relatedProduct.price, 0, 'COMMA', 0, 'POINT')} + '₫'">0₫</span>
                                <a th:href="@{/products/{id}(id=${relatedProduct.id})}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container py-5" th:if="${product == null}">
        <div class="text-center">
            <i class="bi bi-exclamation-triangle display-1 text-muted"></i>
            <h2 class="mt-3">Không Tìm Thấy Sản Phẩm</h2>
            <a th:href="@{/products}" class="btn btn-primary mt-3"><i class="bi bi-arrow-left me-2"></i>Quay Lại</a>
        </div>
    </div>
    
    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/cart-manager.js(v=1)}"></script>
    <script th:src="@{/js/cart-sync.js(v=1)}"></script>
    <script th:src="@{/js/cart-animations-v2.js(v=1)}"></script>
    <script th:src="@{/js/ecommerce-enhanced.js(v=1)}"></script>
    <script th:src="@{/js/product-detail.js(v=1)}"></script>
    <script th:src="@{/js/header.js(v=1)}"></script>
</body>
</html>
