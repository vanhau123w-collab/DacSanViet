<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>Thanh Toán - Đặc Sản Quê Hương</title>
</head>
<body>
    <th:block layout:fragment="content">
        <div class="container py-4">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/}">Trang Chủ</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/cart}">Giỏ Hàng</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Thanh Toán</li>
                </ol>
            </nav>

            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="fw-bold">
                        <i class="bi bi-credit-card me-2"></i>Thanh Toán
                    </h1>
                </div>
            </div>

            <!-- Checkout Steps -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="progress" style="height: 3px;">
                        <div class="progress-bar" role="progressbar" style="width: 100%"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <small class="text-success"><i class="bi bi-check-circle me-1"></i>Giỏ hàng</small>
                        <small class="text-primary fw-bold">Thông tin giao hàng</small>
                        <small class="text-muted">Thanh toán</small>
                        <small class="text-muted">Hoàn thành</small>
                    </div>
                </div>
            </div>

            <form th:action="@{/checkout/process}" method="post" id="checkoutForm">
                <div class="row">
                    <!-- Checkout Form -->
                    <div class="col-lg-8">
                        <!-- Customer Information -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-person me-2"></i>Thông Tin Khách Hàng
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="fullName" class="form-label">Họ và tên <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="fullName" name="fullName" 
                                               th:value="${user != null ? user.fullName : ''}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="phoneNumber" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                        <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber" 
                                               th:value="${user != null ? user.phoneNumber : ''}" required>
                                    </div>
                                    <div class="col-12">
                                        <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                        <input type="email" class="form-control" id="email" name="email" 
                                               th:value="${user != null ? user.email : ''}" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Shipping Address -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-geo-alt me-2"></i>Địa Chỉ Giao Hàng
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Saved Addresses -->
                                <div th:if="${user != null and user.addresses != null and !user.addresses.empty}" class="mb-3">
                                    <label class="form-label">Chọn địa chỉ có sẵn:</label>
                                    <div th:each="address, iterStat : ${user.addresses}" class="form-check">
                                        <input class="form-check-input" type="radio" name="savedAddress" 
                                               th:id="'address' + ${iterStat.index}" th:value="${address.id}"
                                               th:checked="${iterStat.first}">
                                        <label class="form-check-label" th:for="'address' + ${iterStat.index}">
                                            <strong th:text="${address.fullName}">Name</strong><br>
                                            <span th:text="${address.phoneNumber}">Phone</span><br>
                                            <span th:text="${address.addressLine + ', ' + address.ward + ', ' + address.district + ', ' + address.city}">Address</span>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="savedAddress" id="newAddress" value="new">
                                        <label class="form-check-label" for="newAddress">
                                            <strong>Sử dụng địa chỉ mới</strong>
                                        </label>
                                    </div>
                                </div>

                                <!-- New Address Form -->
                                <div id="newAddressForm" th:class="${user == null or user.addresses == null or user.addresses.empty} ? '' : 'd-none'">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="shippingFullName" class="form-label">Họ và tên người nhận <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="shippingFullName" name="shippingFullName">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="shippingPhone" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                            <input type="tel" class="form-control" id="shippingPhone" name="shippingPhone">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="city" class="form-label">Tỉnh/Thành phố <span class="text-danger">*</span></label>
                                            <select class="form-select" id="city" name="city" required>
                                                <option value="">Chọn tỉnh/thành phố</option>
                                                <option value="Ho Chi Minh">TP. Hồ Chí Minh</option>
                                                <option value="Ha Noi">Hà Nội</option>
                                                <option value="Da Nang">Đà Nẵng</option>
                                                <option value="Can Tho">Cần Thơ</option>
                                                <!-- Add more cities -->
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="district" class="form-label">Quận/Huyện <span class="text-danger">*</span></label>
                                            <select class="form-select" id="district" name="district" required>
                                                <option value="">Chọn quận/huyện</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="ward" class="form-label">Phường/Xã <span class="text-danger">*</span></label>
                                            <select class="form-select" id="ward" name="ward" required>
                                                <option value="">Chọn phường/xã</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <label for="addressLine" class="form-label">Địa chỉ cụ thể <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="addressLine" name="addressLine" 
                                                   placeholder="Số nhà, tên đường..." required>
                                        </div>
                                        <div class="col-12">
                                            <label for="notes" class="form-label">Ghi chú giao hàng</label>
                                            <textarea class="form-control" id="notes" name="notes" rows="2" 
                                                      placeholder="Ghi chú cho người giao hàng (tùy chọn)"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-credit-card me-2"></i>Phương Thức Thanh Toán
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="paymentMethod" 
                                                   id="cod" value="COD" checked>
                                            <label class="form-check-label" for="cod">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-cash me-2 text-success"></i>
                                                    <div>
                                                        <strong>Thanh toán khi nhận hàng (COD)</strong>
                                                        <br><small class="text-muted">Thanh toán bằng tiền mặt khi nhận hàng</small>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="paymentMethod" 
                                                   id="bank" value="BANK_TRANSFER">
                                            <label class="form-check-label" for="bank">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-bank me-2 text-primary"></i>
                                                    <div>
                                                        <strong>Chuyển khoản ngân hàng</strong>
                                                        <br><small class="text-muted">Chuyển khoản trước khi giao hàng</small>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Bank Transfer Details -->
                                <div id="bankDetails" class="mt-3 p-3 bg-light rounded d-none">
                                    <h6>Thông tin chuyển khoản:</h6>
                                    <p class="mb-1"><strong>Ngân hàng:</strong> Vietcombank</p>
                                    <p class="mb-1"><strong>Số tài khoản:</strong> 1234567890</p>
                                    <p class="mb-1"><strong>Chủ tài khoản:</strong> Đặc Sản Quê Hương</p>
                                    <p class="mb-0"><strong>Nội dung:</strong> Thanh toán đơn hàng [Mã đơn hàng]</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="col-lg-4">
                        <div class="card sticky-top" style="top: 100px;">
                            <div class="card-header">
                                <h5 class="mb-0">Đơn Hàng Của Bạn</h5>
                            </div>
                            <div class="card-body">
                                <!-- Order Items -->
                                <div class="order-items mb-3" th:if="${cart != null and !cart.items.empty}">
                                    <div class="d-flex align-items-center mb-2" th:each="item : ${cart.items}">
                                        <img th:src="${item.product.imageUrl != null ? item.product.imageUrl : '/images/placeholder-product.jpg'}" 
                                             class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;"
                                             th:alt="${item.product.name}">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-0 small" th:text="${item.product.name}">Product</h6>
                                            <small class="text-muted">Số lượng: <span th:text="${item.quantity}">1</span></small>
                                        </div>
                                        <span class="fw-bold small" th:text="${#numbers.formatCurrency(item.product.price * item.quantity)}">$0.00</span>
                                    </div>
                                </div>

                                <hr>

                                <!-- Order Summary -->
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Tạm tính:</span>
                                    <span th:text="${#numbers.formatCurrency(cart.subtotal)}">$0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Phí vận chuyển:</span>
                                    <span class="text-success">Miễn phí</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Thuế VAT:</span>
                                    <span th:text="${#numbers.formatCurrency(cart.tax != null ? cart.tax : 0)}">$0.00</span>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between mb-3">
                                    <strong>Tổng cộng:</strong>
                                    <strong class="text-primary" th:text="${#numbers.formatCurrency(cart.total)}">$0.00</strong>
                                </div>

                                <!-- Place Order Button -->
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-check-circle me-2"></i>Đặt Hàng
                                    </button>
                                </div>

                                <!-- Security Info -->
                                <div class="mt-3 text-center">
                                    <small class="text-muted">
                                        <i class="bi bi-shield-check me-1"></i>
                                        Thông tin của bạn được bảo mật an toàn
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </th:block>

    <th:block layout:fragment="scripts-extra">
        <script>
            // Toggle new address form
            document.querySelectorAll('input[name="savedAddress"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const newAddressForm = document.getElementById('newAddressForm');
                    if (this.value === 'new') {
                        newAddressForm.classList.remove('d-none');
                    } else {
                        newAddressForm.classList.add('d-none');
                    }
                });
            });

            // Toggle payment method details
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const bankDetails = document.getElementById('bankDetails');
                    if (this.value === 'BANK_TRANSFER') {
                        bankDetails.classList.remove('d-none');
                    } else {
                        bankDetails.classList.add('d-none');
                    }
                });
            });

            // Form validation
            document.getElementById('checkoutForm').addEventListener('submit', function(e) {
                const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                const savedAddress = document.querySelector('input[name="savedAddress"]:checked');
                
                if (!savedAddress || savedAddress.value === 'new') {
                    // Validate new address fields
                    const requiredFields = ['shippingFullName', 'shippingPhone', 'city', 'district', 'ward', 'addressLine'];
                    let isValid = true;
                    
                    requiredFields.forEach(fieldName => {
                        const field = document.getElementById(fieldName);
                        if (!field.value.trim()) {
                            field.classList.add('is-invalid');
                            isValid = false;
                        } else {
                            field.classList.remove('is-invalid');
                        }
                    });
                    
                    if (!isValid) {
                        e.preventDefault();
                        showAlert('danger', 'Vui lòng điền đầy đủ thông tin địa chỉ giao hàng.');
                        return;
                    }
                }
                
                // Show loading
                showLoadingSpinner();
            });

            // Populate districts and wards (simplified)
            document.getElementById('city').addEventListener('change', function() {
                const district = document.getElementById('district');
                const ward = document.getElementById('ward');
                
                // Clear existing options
                district.innerHTML = '<option value="">Chọn quận/huyện</option>';
                ward.innerHTML = '<option value="">Chọn phường/xã</option>';
                
                // Add sample districts (in real app, this would be an API call)
                if (this.value === 'Ho Chi Minh') {
                    const districts = ['Quận 1', 'Quận 2', 'Quận 3', 'Quận 7', 'Quận Thủ Đức'];
                    districts.forEach(d => {
                        const option = document.createElement('option');
                        option.value = d;
                        option.textContent = d;
                        district.appendChild(option);
                    });
                }
            });

            document.getElementById('district').addEventListener('change', function() {
                const ward = document.getElementById('ward');
                ward.innerHTML = '<option value="">Chọn phường/xã</option>';
                
                // Add sample wards
                if (this.value) {
                    const wards = ['Phường 1', 'Phường 2', 'Phường 3', 'Phường 4'];
                    wards.forEach(w => {
                        const option = document.createElement('option');
                        option.value = w;
                        option.textContent = w;
                        ward.appendChild(option);
                    });
                }
            });
        </script>
    </th:block>
</body>
</html>